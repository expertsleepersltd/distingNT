<!DOCTYPE html>
<head>

<title>disting NT Preset Editor</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">

<style>
body {
	font-family: 'PT Sans', serif;
}
button {
	font-family: 'PT Sans', serif;
}
button.big {
	font-size: 120%;
}
select {
	font-family: 'PT Sans', serif;
}
div.small {
	font-size: 80%;
}
td.tc {
	text-align: center;
	background-color: #c0c0c0;
	font-size: 80%;
}
tr.a {
	background-color: #e0e0e0;
}
th {
	background-color: #c0c0c0;
	font-size: 80%;
}
textarea {
    font-family: monospace;
}
input.param_v {
	width: 50px;
}
input.param_s {
	width: 400px;
	height: 10px;
	-webkit-appearance: none;
	background-color: #f0f0f0;
	-webkit-border-radius: 20px;
}
button.param_def {
	width: 40px;
}
div.pv_string {
	display: inline;
}
.hidden {
	position:absolute;
	left:-10000px;
	top:auto;
	width:1px;
	height:1px;
	overflow:hidden;
}
th.routingI {
	text-align: center;
	width: 2em;
	background-color: #c0c0c0;
}
th.routingO {
	text-align: center;
	width: 2em;
	background-color: #e0e0e0;
}
th.routingA {
	text-align: center;
	width: 2em;
	background-color: #c0c0c0;
}
td.routing {
	text-align: center;
}
td.routingL {
	text-align: center;
    border-left: thin;
    border-left-style: dashed;
    border-color: #808080;
}
td.routingSlotName {
	text-align: center;
	background-color: #f0f0f0;
	white-space: nowrap;
}
td.routingSlot {
	text-align: center;
}
.lua-controls {
    margin: 10px 0;
}
.lua-editor {
    margin: 10px 0;
	display: none;
}
.lua-editor-header {
	display: flex;
	gap: 10px;
	align-items: center;
	margin: 20px 0;
}
#luaScript {
    width: 100%;
	max-width: 800px;
	min-height: 1024px;
    font-family: monospace;
    background-color: #f8f8f8;
    border: 1px solid #ddd;
    padding: 10px;
}
.map_ui_lua {
    display: none;
}

/* New styling for the slot grid */
#slotGrid {
    margin: 10px 0;
}
.slotRow {
    margin-bottom: 5px;
}
.slotBtn {
    width: 40px;
    height: 40px;
    margin: 2px;
    font-size: 14px;
    border: 1px solid #ccc;
    background-color: #eee;
    cursor: pointer;
}
.slotBtn:hover {
    background-color: #ddd;
}
.selectedSlotBtn {
    background-color: #88f;
    color: #fff;
}

</style>

<script>
// Add selectedSlot variable at the top level
var selectedSlot = 0;

function log( t ) {
	var ta = document.getElementById( "log" );
	var d = new Date();
	var dd = d.toLocaleTimeString();
	ta.value = ta.value + "\n" + dd + ": " + t;
	ta.scrollTop = ta.scrollHeight;
	return dd;
}
function status( t ) {
    document.getElementById( "status" ).innerHTML = "Web MIDI status: " + t;
}
function nybbleChar( n ) {
	if ( n >= 10 ) {
		return String.fromCharCode( 'A'.charCodeAt( 0 ) + n - 10 );
	}
	return String.fromCharCode( '0'.charCodeAt( 0 ) + n );
}
function makeMsgSysEx() {
	var d = [0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x02]
	var len = d.length
	var str = ""
	for ( var i = 0; i < len; ++i ) {
		str += String.fromCharCode( d[i] );
	}
	var text = "Hello!\nThis message\nwas sent from\nthe config tool.";
	str += text;
	str += String.fromCharCode( 0xF7 );
	return str;
}
function dumpSysex( data, id, prefix ) {
	let len = data.length
	let h = prefix
	for ( let i = 0; i < len; ++i ) {
		let b = data[ i ];
		h += nybbleChar( b >> 4 );
		h += nybbleChar( b & 0xf );
		h += " ";
		if ( ( i & 0xf ) === 0xf ) {
			h += "\n";
		}
	}
	if ( document.getElementById( 'keep_log').checked ) {
		h += "\n";
		document.getElementById( id ).value += h;
	}
	else {
		document.getElementById( id ).value = h;
	}
}

function buildSlotGrid() {
    let container = document.getElementById('slotGrid');
    container.innerHTML = '';
    // 2 rows, 16 columns = 32 slots total
    for (let row = 0; row < 2; row++) {
        let rowDiv = document.createElement('div');
        rowDiv.className = 'slotRow';
        for (let col = 0; col < 16; col++) {
            let slotIndex = row * 16 + col;
            let slotNumber = slotIndex + 1;
            let btn = document.createElement('button');
            btn.className = 'slotBtn';
            btn.innerText = slotNumber;
            btn.onclick = () => selectSlot(slotIndex);
            rowDiv.appendChild(btn);
        }
        container.appendChild(rowDiv);
    }
    highlightSelectedSlot();
}

function highlightSelectedSlot() {
    let container = document.getElementById('slotGrid');
    let buttons = container.getElementsByClassName('slotBtn');
    for (let i = 0; i < buttons.length; i++) {
        let btn = buttons[i];
        if (i === selectedSlot) {
            btn.classList.add('selectedSlotBtn');
        } else {
            btn.classList.remove('selectedSlotBtn');
        }
    }
}

function selectSlot(slot) {
    selectedSlot = slot;
    highlightSelectedSlot();
    changeSlot();
}




</script>

</head>

<body>

<div class="small">
At the time of writing this will work only in Google's <a href="http://www.google.com/chrome/">Chrome</a> browser. Chrome may block SysEx access if you run this from a website, in which case download the html file locally and run it from there.
</div>
<div class="small" id="status"></div>
<p>

<!--<button  accesskey="s" onclick="sendMsg()">Send Msg</button>-->
<button class="big"  accesskey="r" onclick="refresh()">Refresh</button>
<label for="midioutput">Send to MIDI port:</label>
<select id="midioutput"  onchange='changeOutput()' accesskey="o"></select>
<label for="midiinput">Listen on MIDI port: </label>
<select id="midiinput"  accesskey="i" onchange='changeInput()'></select>
<label for="sysExId">SysEx ID: </label>
<select id="sysExId" onchange='changeSysExId()' accesskey="s">
<script>
for ( let i=0; i<127; ++i ) {
	document.write( "<option value=" + i + ">" + i + "</option>" );
}
</script>
</select>
<!-- <label for="slot">Slot: </label>
<select id="slot" onchange='changeSlot()'>
<script>
for ( let i=0; i<32; ++i ) {
	document.write( '<option value=' + i + '>' + (i+1) + '</option>' );
}
</script>
</select> -->
<label for="keep_log">Keep full log:</label><input id='keep_log' type='checkbox'>
<button onclick="wake()">Wake</button>
<p>
<label class="hidden" for="log">Log:</label><textarea rows=5 cols=50 id="log" accesskey="l" class="log" readOnly></textarea>
<label class="hidden" for="txSysex">SysEx sent:</label><textarea rows=5 cols=45 name="text" id="txSysex" accesskey="y"></textarea>
<label class="hidden" for="rxSysex">SysEx received:</label><textarea rows=5 cols=45 name="text" id="rxSysex" accesskey="x"></textarea>
</p>
<label for="slot">Slot: 
	<div id="slotGrid"></div>
</label>



<button class="big" onclick="showSlotEditor()">Edit parameters</button>
<button class="big" onclick="showRoutingAnalysis()">Show routing</button>
<hr>

<div id=slotEditor>

<!--
<button onclick='loadPreset()'>Load</button>
<button onclick='newPreset()'>New</button>
<button onclick='savePreset(0)'>Save (prompt)</button>
<button onclick='savePreset(1)'>Save (safe)</button>
<button onclick='savePreset(2)'>Save (force)</button>
<button onclick='moveAlgorithmUp()'>Move algorithm up</button>
-->
<label for="algorithms_menu">Algorithms:</label>
<select id="algorithms_menu" onchange='changeAlgorithm()'></select>
<label id='spec1label' for="spec1"></label>
<input id='spec1' type='number'></input>
<label id='spec2label' for="spec2"></label>
<input id='spec2' type='number'></input>
<label id='spec3label' for="spec3"></label>
<input id='spec3' type='number'></input>
<button id='addAlgorithmButton' onclick='addAlgorithm()'>Add</button>
<p>
<label for="auto_focus">Auto-focus:</label><input id='auto_focus' type='checkbox' checked accesskey="u">
<label for="show_mapping_cv">Show CV mappings:</label>
<input id='show_mapping_cv' type='checkbox' accesskey="c" onchange="toggleMappings('cv')">
<label for="show_mapping_midi">Show MIDI mappings:</label>
<input id='show_mapping_midi' type='checkbox' accesskey="m" onchange="toggleMappings('midi')">
<label for="show_mapping_i2c">Show I2C mappings:</label>
<input id='show_mapping_i2c' type='checkbox' accesskey="2" onchange="toggleMappings('i2c')">
<label for="show_ui_lua">Show UI Lua Builder:</label>
<input id='show_ui_lua' type='checkbox' accesskey="l" onchange="toggleUILua()">
<br>
<label for="preset_name">Preset name:</label><input id='preset_name' accesskey='p' type='text' onchange='send_preset_name()'>
<p>
<div id='slot_algorithm_name'></div>
<button id='removeAlgorithmButton' onclick='removeAlgorithm()'>Remove</button>
<p>
<div id='parameters'></div>

</div> <!--slotEditor-->

<div id=routingAnalysis>

<label for="show_signals">Show signals:</label><input id='show_signals' type='checkbox' onchange="buildRoutingInfo()" checked>
<label for="show_mappings">Show mappings:</label><input id='show_mappings' type='checkbox' onchange="buildRoutingInfo()" checked>
<label for="routing_colour1">Colour 1:</label><input id='routing_colour1' type='color' onchange='buildRoutingInfo()'>
<label for="routing_colour2">Colour 2:</label><input id='routing_colour2' type='color' onchange='buildRoutingInfo()'>

<div id=routingAnalysisContent></div>

</div> <!--routingAnalysis-->

<div id="uiLuaBuilder" style="display: none;"></div>
    <div class="lua-editor">
		<div class="lua-editor-header">
			<h3>Lua Script Preview</h3>
			<button id="downloadLuaBtn" onclick="downloadLuaScript()">Download Lua Script</button>
			<button onclick="deleteLuaParams()">Delete UI Mapping</button>
			<label for="show_preview">Show Preview:</label>
			<input type="checkbox" id="show_preview" onchange="togglePreview()" checked>
			<br>
			<canvas id="previewCanvas" width="256" height="64" style="border:1px solid #ccc; display:none;"></canvas>
		</div>
        <textarea id="luaScript" rows="20" readonly></textarea>
    </div>
</div> 

<script>
const dntRoutingColour1Key = "dntRoutingColour1";
const dntRoutingColour2Key = "dntRoutingColour2";

if ( !localStorage.getItem( dntRoutingColour1Key ) ) {
    localStorage.setItem( dntRoutingColour1Key, "#b3fff0" );
}
if ( !localStorage.getItem( dntRoutingColour2Key ) ) {
    localStorage.setItem( dntRoutingColour2Key, "#d9ffb3" );
}
document.getElementById( 'routing_colour1' ).value = localStorage.getItem( dntRoutingColour1Key );
document.getElementById( 'routing_colour2' ).value = localStorage.getItem( dntRoutingColour2Key );

var routingAnalysisMode = false;
function showSlotEditor() {
	routingAnalysisMode = false;
	document.getElementById( "routingAnalysis" ).style.display = "none";
	request();
	document.getElementById( "slotEditor" ).style.display = "inline";
}
function showRoutingAnalysis() {
	routingAnalysisMode = true;
	document.getElementById( "slotEditor" ).style.display = "none";
	requestRouting();
	document.getElementById( "routingAnalysis" ).style.display = "inline";
}
document.getElementById( "routingAnalysis" ).style.display = "none";

function lookupGuid( guid ) {
	for ( let i=0; i<numAlgorithms; ++i ) {
		if ( guid[0] == factories[i][0][0] && guid[1] == factories[i][0][1] && guid[2] == factories[i][0][2] && guid[3] == factories[i][0][3] ) {
			return i;
		}
	}
	return -1;
}

function processAlgorithm(slot, data) {
    let guid = data.slice(0, 4);
    let f = lookupGuid(guid);
    if (f < 0) {
        console.warn("No matching algorithm found for GUID:", guid);
        return; 
    }

    if (routingAnalysisMode) {
        guids[slot] = f;
    } else {
        // Only update the UI if this is the currently selected slot
        if (slot === selectedSlot) {
            if (factories[f] && factories[f][3] && factories[f][3][0]) {
                document.getElementById("slot_algorithm_name").innerHTML = factories[f][3][0];
            } else {
                console.warn("Algorithm data missing for factory index:", f);
            }
        }
    }
}
function processPresetName( data ) {
	var name = "";
	for ( var i = 0; i < 21; ++i ) {
		var n = data[i];
		if ( n == 0 ) {
			break;
		}
		name += String.fromCharCode( n );
	}
	document.getElementById( "preset_name" ).value = name;
}

var numAlgorithms = 0;

function processNumAlgorithms( data ) {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let current = document.getElementById( 'algorithms_menu' ).value;
	numAlgorithms = extractShort( data );
	let str = '';
	for ( let i=0; i<numAlgorithms; ++i ) {
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x31, (i>>14)&3, (i>>7)&0x7f, i&0x7f, 0xF7 ];
		output.send( arr );
		let dd = log( "sent algorithm info request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );

		str += '<option value =' + i + '>' + (i+1) + '</option>';
	}
	let m = document.getElementById( 'algorithms_menu' );
	m.innerHTML = str;
	if ( current != "" ) {
		document.getElementById( 'algorithms_menu' ).value = current;
	}
}

var factories = [];

function processAlgorithmInfo( data ) {
	let index = extractShort( data.slice( 0, 3 ) );
	let guid = data.slice( 3, 7 );
	let numSpecs = data[7];
	let factory = [ guid, numSpecs ];
	let algSpecs = [];
	let c = 8;
	for ( let i=0; i<numSpecs; ++i ) {
		let spec = [ extractShort( data.slice( c, c+3 ) ), extractShort( data.slice( c+3, c+6 ) ), extractShort( data.slice( c+6, c+9 ) ), data[c+9] ];
		c += 10;
		algSpecs.push( spec );
	}
	factory.push( algSpecs );
	let names = [];
	for ( let j=0; j<1+numSpecs; ++j ) {
		let name = "";
		for ( let i = 0; i < 32; ++i ) {
			let n = data[c++];
			if ( n == 0 || n == 0xf7 ) {
				break;
			}
			name += String.fromCharCode( n );
		}
		names.push( name );
	}
	factory.push( names );
	if ( index == 0 ) {
		factories = [];
	}
	factories.push( factory );
	let m = document.getElementById( 'algorithms_menu' );
	m.options[ index ].text = names[0];

	if ( index == numAlgorithms-1 ) {
		changeAlgorithm();

		let slot = selectedSlot
		let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x40, slot, 0xF7 ];
		output.send( arr );
		let dd = log( "sent algorithm request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	}
}

var slotCount = 0;
var routingInfo = [];
var guids = [];

function processSlotCount( data ) {
	slotCount = data[0];
	routingInfo = [];
	guids = [];

	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	for ( let i=0; i<slotCount; ++i ) {
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x40, i, 0xF7 ];
		output.send( arr );
		arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x61, i, 0xF7 ];
		output.send( arr );
		let dd = log( "sent routing request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	}
}

function processRoutingInfo( data ) {
	let slot = data[0];
	if ( slot >= slotCount ) {
		return;
	}
	let routing = [];
	let c = 1;
	for ( let i=0; i<6; ++i ) {
		let d = data[c+0] | ( data[c+1] << 7 ) | ( data[c+2] << 14 ) | ( data[c+3] << 21 ) | ( data[c+4] << 28 );
		c += 5;
		routing.push( d );
	}
	routingInfo[ slot ] = routing;
	
	if ( slot == ( slotCount - 1 ) ) {
		buildRoutingInfo();
	}
}

function netInputMask( r ) {
    let inputMask = r[0];
	let mappingMask = r[5];
	let showSignals = document.getElementById( 'show_signals' ).checked;
	let showMappings = document.getElementById( 'show_mappings' ).checked;
	if ( showSignals && showMappings ) {
		return inputMask | mappingMask;
	} else if ( showSignals ) {
		return inputMask;
	} else if ( showMappings ) {
		return mappingMask;
	}
	return 0;
}

function hex2( d ) {
	let r = Number( d.toFixed(0) ).toString(16);
	if ( r.length == 1 ) {
		r = '0' + r;
	}
	return r;
}

function darken( c ) {
	let p = 0.9;
	let r = parseInt( c.substring(1,3), 16 ) * p;
	let g = parseInt( c.substring(3,5), 16 ) * p;
	let b = parseInt( c.substring(5,7), 16 ) * p;
	let h = '#';
	h += hex2( r );
	h += hex2( g );
	h += hex2( b );
	return h;
}

function buildRoutingInfo() {
	let colour1 = document.getElementById( 'routing_colour1' ).value;
	let colour2 = document.getElementById( 'routing_colour2' ).value;
    localStorage.setItem( dntRoutingColour1Key, colour1 );
    localStorage.setItem( dntRoutingColour2Key, colour2 );

	// follow signals from top to bottom
	let signals = [ [0, 1,1,1,1,1,1,1,1,1,1,1,1, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0] ];
	for ( let s=0; s<slotCount; ++s ) {
		let r = routingInfo[ s ];
		let inputMask = netInputMask( r );
		let outputMask = r[1];
		let replaceMask = r[2];
		let row = signals[ signals.length - 1 ];
		let newRow = [ 0 ];
		for ( let i=1; i<=28; ++i ) {
			let v = row[i];
			if ( outputMask & (1<<i) ) {
				if ( replaceMask & (1<<i) ) {
					v = v + 1;
					if ( v > 2 ) {
						v = 1;
					}
				} else if ( v == 0 ) {
					v = 1;
				}
			}
			newRow.push( v );
		}
		signals.push( newRow );
	}
	
	// strip signals that go nowhere
	let showSignals = document.getElementById( 'show_signals' ).checked;
	for ( let i=1; i<=28; ++i ) {
		if ( showSignals && ( i == 13 ) ) {
			i = 21;
		}
		let hasInput = false;
		for ( let s=slotCount; s>=0; s-- ) {
			if ( s < slotCount ) {
				let r = routingInfo[ s ];
				let inputMask = netInputMask( r );
				let replaceMask = r[2];
				if ( replaceMask & (1<<i) ) {
					hasInput = false;
				}
				if ( inputMask & (1<<i) ) {
					hasInput = true;
				}
			}
			if ( !hasInput ) {
				signals[ s ][ i ] = 0;
			}
		}
	}

	let str = "<table class='routing'>";
	let heading = "<tr class='routing'><th colspan=2 />";
	for ( let i=0; i<28; ++i ) {
		let ch = 1 + i;
		let cl = "routingI";
		if ( ch > 12 ) {
			ch -= 12;
			cl = "routingO";
			if ( ch > 8 ) {
				ch -= 8;
				cl = "routingA";
			}
		}
		heading += "<th class='" + cl + "'>" + ch + "</th>";
	}
	heading += "</tr>";
	let heading2 = "<tr class='routing'><th colspan=2 /><th colspan=12>Inputs</th><th colspan=8>Outputs</th><th colspan=8>Aux</th></tr>";
	str += heading2;
	str += heading;
	let colours = [ "#ffffff", colour1, colour2, "#fcfcfc", darken( colour1 ), darken( colour2 ) ];
	for ( let s=0; s<slotCount; ++s ) {
		let r = routingInfo[ s ];
		let inputMask = netInputMask( r );
		let outputMask = r[1];
		let replaceMask = r[2];
		let effectiveInput = inputMask | ( outputMask & ~replaceMask );
		let row = signals[ s ];
		str += "<tr class='routing'><td /><td />";
		for ( let i=1; i<=28; ++i ) {
			let ch = i;
			if ( ch > 12 ) {
				ch -= 12;
				if ( ch > 8 ) {
					ch -= 8;
				}
			}
			let sty = "background-color:" + colours[ row[i] + 3*(i&1) ];
			let cl = ( ch == 1 ) ? 'routingL' : 'routing';
			str += "<td class='" + cl + "' style='" + sty + "'>" + ( ( effectiveInput & (1<<i) ) ? "&darr;" : "&nbsp;" ) + "</td>";
		}
		str += "</tr>";
		str += "<tr class='routingSlot'>";
		str += "<td class='routingSlotName'>" + (s+1) + "</td>";
		str += "<td class='routingSlotName'>" + factories[ guids[s] ][3][0] + "</td>";
		let used = r[0] | r[5] | outputMask;
		for ( let i=1; i<=28; ++i ) {
			let ch = i;
			if ( ch > 12 ) {
				ch -= 12;
				if ( ch > 8 ) {
					ch -= 8;
				}
			}
			let sty = "background-color:" + ( ( used & (1<<i) ) ? "#d0d0d0" : ( row[i] ? colours[ row[i] + 3*(i&1) ] : "#f0f0f0" ) );
			let cl = ( ch == 1 ) ? 'routingL' : 'routing';
			str += "<td class='" + cl + "' style='" + sty + "'>" + ( ( used & (1<<i) ) ? ch : "&nbsp;" ) + "</td>";
		}
		str += "</tr>";
		row = signals[ s+1 ];
		str += "<tr class='routing'><td /><td />";
		for ( let i=1; i<=28; ++i ) {
			let ch = i;
			if ( ch > 12 ) {
				ch -= 12;
				if ( ch > 8 ) {
					ch -= 8;
				}
			}
			let sty = "background-color:" + colours[ row[i] + 3*(i&1) ];
			let cl = ( ch == 1 ) ? 'routingL' : 'routing';
			let replace = replaceMask & (1<<i);
			str += "<td class='" + cl + "' style='" + sty + "'>" + ( ( outputMask & (1<<i) ) ? ( replace ? "&#9523;" : "+" ) : "&nbsp;" ) + "</td>";
		}
		str += "</tr>";
	}
	str += heading;
	str += heading2;
	str += "</table>";
	document.getElementById( 'routingAnalysisContent' ).innerHTML = str;
}

function showMappings( n ) {
	let vis = document.getElementById( "show_mapping_"+n ).checked ? "table-cell" : "none";
	let elts = document.getElementsByClassName( 'map_'+n );
	for ( let e of elts ) {
    	e.style.display = vis;
	}
}

function toggleMappings( n ) {
	showMappings( n );
	if ( !mappingRefreshed ) {
		requestMapping() ;
	}
}

var mappingRefreshed = false;
var mappingTypes = [ "cv", "midi", "i2c" ];

function anyMappingVisible() {
	for ( let n of mappingTypes ) {
		if ( document.getElementById( "show_mapping_"+n ).checked ) {
			return true;
		}
	}
	return false;
}

function refreshMappingVisibility() {
	for ( let n of mappingTypes ) {
		showMappings( n );
	}
}

unitStrings = [];
function processUnitStrings( data ) {
	var num = data[0];
	var c = 1;
	unitStrings = [];
    for ( var j = 0; j < num; ++j ) {
		var name = "";
		for ( var i = 0; i < 100; ++i ) {
			var n = data[c++];
			if ( n == 0 ) {
				break;
			}
			name += String.fromCharCode( n );
		}
		unitStrings.push( name );
	}
}

function processEnumStrings( data ) {
	var p = extractShort( data.slice( 0, 3 ) );
	var num = data[3];
	var c = 4;
	var str = "";
	let toggle = ( num == 2 );
    for ( var j = 0; j < num; ++j ) {
		var name = "";
		for ( var i = 0; i < 100; ++i ) {
			var n = data[c++];
			if ( n == 0 ) {
				break;
			}
			name += String.fromCharCode( n );
		}
		str += "<option value=" + j + ">" + name + "</option>";
		if ( j == 0 && name != "Off" ) {
			toggle = false;
		}
		if ( j == 1 && name != "On" ) {
			toggle = false;
		}
	}
	if ( toggle ) {
		var e = document.getElementById( "p" + p + "_c" );
		var v = document.getElementById( "p" + p + "_s" ).value;
		e.checked = v != 0;
		e.style = 'display:inline;';
	}
	else {
		var e = document.getElementById( "p" + p + "_e" );
		e.innerHTML = str;
		e.value = document.getElementById( "p" + p + "_s" ).value;
		e.style = 'display:inline;';
	}
}

function processMapping( data ) {
	let p = extractShort( data.slice( 0, 3 ) );
	let c = 3;
	let version = data[c]; c++;
	if ( version != 1 ) {
		alert( "Version of the mapping data does not match the expected value for this version of the tool" );
		return;
	}
	{
		let input = data[c]; c++;
		let flags = data[c]; c++;
		let volts = data[c]; c++;
		let delta = extractShort( data.slice( c, c+3 ) ); c += 3;

		document.getElementById( "p" + p + "_cv_input" ).value = input;
		document.getElementById( "p" + p + "_cv_uni" ).checked = flags & 1;
		document.getElementById( "p" + p + "_cv_gate" ).checked = flags & 2;
		document.getElementById( "p" + p + "_cv_volts" ).value = volts;
		document.getElementById( "p" + p + "_cv_delta" ).value = delta;

		style_cv_input( p );
	}
	{
		let cc = data[c]; c++;
		let flags = data[c]; c++;
		let min = extractShort( data.slice( c, c+3 ) ); c += 3;
		let max = extractShort( data.slice( c, c+3 ) ); c += 3;
		if ( flags & 4 ) {
			cc = 128;
		}
		document.getElementById( "p" + p + "_midi_ch" ).value = ( flags >> 3 ) & 0xf;
		document.getElementById( "p" + p + "_midi_cc" ).value = cc;
		document.getElementById( "p" + p + "_midi_en" ).checked = flags & 1;
		document.getElementById( "p" + p + "_midi_sym" ).checked = flags & 2;
		document.getElementById( "p" + p + "_midi_min" ).value = min;
		document.getElementById( "p" + p + "_midi_max" ).value = max;
	}
	{
		let cc = data[c]; c++;
		let flags = data[c]; c++;
		let min = extractShort( data.slice( c, c+3 ) ); c += 3;
		let max = extractShort( data.slice( c, c+3 ) ); c += 3;
		document.getElementById( "p" + p + "_i2c_cc" ).value = cc;
		document.getElementById( "p" + p + "_i2c_en" ).checked = flags & 1;
		document.getElementById( "p" + p + "_i2c_sym" ).checked = flags & 2;
		document.getElementById( "p" + p + "_i2c_min" ).value = min;
		document.getElementById( "p" + p + "_i2c_max" ).value = max;
	}
	mappingRefreshed = true;
}

nextParameterToGet = 0;
numParametersToGet = 0;
function getNextParameter() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x43, selectedSlot, (nextParameterToGet>>14)&3, (nextParameterToGet>>7)&0x7f, nextParameterToGet&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent parameter info request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	nextParameterToGet += 1;
	if ( nextParameterToGet >= numParametersToGet ) {
		return;
	}
	setTimeout( getNextParameter, 20 );
}

numParameters = 0;
function processNumParameters( data ) {
    let num = extractShort( data.slice( 0, 3 ) );
    if ( num >= 256 ) {
        alert( "Invalid num parameters in processNumParameters()" );
        return;
    }
    numParameters = num;
    var str = "<table>";
    str += "<thead>";
    str += "<tr><th colspan=8>Preset</th><th colspan=5 class='map_cv'>CV Mapping</th><th colspan=6 class='map_midi'>MIDI Mapping</th><th colspan=5 class='map_i2c'>I2C Mapping</th><th colspan=5 class='map_ui_lua'>UI Builder</th></tr>";
    str += "<tr><th></th><th>Name</th><th>Min</th><th>Max</th><th>Default</th><th>Unit</th><th>Value</th><th>Control</th>";
    str += "<th class='map_cv'>Source</th><th class='map_cv'>Unipolar</th><th class='map_cv'>Gate</th><th class='map_cv'>Volts</th><th class='map_cv'>Delta</th>";
    str += "<th class='map_midi'>Channel</th><th class='map_midi'>CC</th><th class='map_midi'>Enabled</th><th class='map_midi'>Symmetric</th><th class='map_midi'>Min</th><th class='map_midi'>Max</th>";
    str += "<th class='map_i2c'>ID</th><th class='map_i2c'>Enabled</th><th class='map_i2c'>Symmetric</th><th class='map_i2c'>Min</th><th class='map_i2c'>Max</th>";
    str += "<th class='map_ui_lua'>Controller</th><th class='map_ui_lua'>Nickname</th><th class='map_ui_lua'>Min</th><th class='map_ui_lua'>Max</th><th class='map_ui_lua'>Invert</th>";
    str += "</tr>";
    str += "</thead><tbody>";

    for ( let i=0; i<num; ++i ) {
        str += "<tr id=row" + i + " class=" + ((i&1)?"a":"b") + "><td>" + (i+1) + "</td>";
        str += "<td id=p" + i + "_name><h1>" + "</h1></td>";
        str += "<td id=p" + i + "_min>" + "</td>";
        str += "<td id=p" + i + "_max>" + "</td>";
        var focus = " onfocus='param_focus(" + i + ")' ";
        str += "<td><button id=p" + i + "_def class='param_def' onclick='param_def(" + i + ")'" + focus + "></button></td>";
        str += "<td id=p" + i + "_unit>" + "</td>";
        str += "<td><input id=p" + i + "_v type='number' class='param_v' size=6 onchange='param_text(" + i + ")'" + focus + ">" + "</td>";
        str += "<td>";
        str += "<input id=p" + i + "_s type='range' min='-32768' max='32767' class='param_s' onInput='param_slider(" + i + ")' ondblclick='param_def(" + i + ")'" + focus + ">";
        str += "<select id=p" + i + "_e class='param_e' onchange='param_enum(" + i + ")' style='display:none;'" + focus + "></select>";
        str += "<input id=p" + i + "_c type='checkbox' class='param_c' onchange='param_check(" + i + ")' style='display:none;'" + focus + ">";
        str += "<div class='pv_string' id=p" + i + "_pv></div>";
        str += "</td>";

        {
            str += "<td class='map_cv'><select id=p" + i + "_cv_input onchange='mapping_cv_input(" + i + ")'><option value=0>None</option>";
            for ( let j=1; j<=12; ++j ) {
                str += "<option value=" + j + ">Input " + j + "</option>";
            }
            for ( let j=1; j<=8; ++j ) {
                str += "<option value=" + (12+j) + ">Output " + j + "</option>";
            }
            for ( let j=1; j<=8; ++j ) {
                str += "<option value=" + (20+j) + ">Aux " + j + "</option>";
            }
            str += "</select></td>";
            str += "<td class='map_cv'><input id=p" + i + "_cv_uni type='checkbox' class='param_c' onchange='mapping_cv_uni(" + i + ")'></td>";
            str += "<td class='map_cv'><input id=p" + i + "_cv_gate type='checkbox' class='param_c' onchange='mapping_cv_gate(" + i + ")'></td>";
            str += "<td class='map_cv'><input id=p" + i + "_cv_volts type='number' class='param_v' size=3 step='1' min='1' max='12' onchange='mapping_cv_volts(" + i + ")'></td>";
            str += "<td class='map_cv'><input id=p" + i + "_cv_delta type='number' class='param_v' size=7 step='1' min='-32768' max='32767' onchange='mapping_cv_delta(" + i + ")'></td>";
        }

        str += "<td class='map_midi'><select id=p" + i + "_midi_ch class='param_v' onchange='mapping_midi_ch(" + i + ")'>";
        for ( let j=0; j<16; ++j ) {
            str += "<option value=" + j + ">" + (j+1) + "</option>";
        }
        str += "<td class='map_midi'><select id=p" + i + "_midi_cc class='param_v' onchange='mapping_midi_cc(" + i + ")'>";
        for ( let j=0; j<128; ++j ) {
            str += "<option value=" + j + ">" + j + "</option>";
        }
        str += "<option value=128>Aftertouch</option></select></td>";
        str += "<td class='map_midi'><input id=p" + i + "_midi_en type='checkbox' class='param_c' onchange='mapping_midi_en(" + i + ")'></td>";
        str += "<td class='map_midi'><input id=p" + i + "_midi_sym type='checkbox' class='param_c' onchange='mapping_midi_sym(" + i + ")'></td>";
        str += "<td class='map_midi'><input id=p" + i + "_midi_min type='number' class='param_v' size=6 min='-32768' max='32767' onchange='mapping_midi_min(" + i + ")'></td>";
        str += "<td class='map_midi'><input id=p" + i + "_midi_max type='number' class='param_v' size=6 min='-32768' max='32767' onchange='mapping_midi_max(" + i + ")'></td>";

        str += "<td class='map_i2c'><input id=p" + i + "_i2c_cc type='number' class='param_v' size=3 min='0' max='127' onchange='mapping_i2c_cc(" + i + ")'></td>";
        str += "<td class='map_i2c'><input id=p" + i + "_i2c_en type='checkbox' class='param_c' onchange='mapping_i2c_en(" + i + ")'></td>";
        str += "<td class='map_i2c'><input id=p" + i + "_i2c_sym type='checkbox' class='param_c' onchange='mapping_i2c_sym(" + i + ")'></td>";
        str += "<td class='map_i2c'><input id=p" + i + "_i2c_min type='number' class='param_v' size=6 min='-32768' max='32767' onchange='mapping_i2c_min(" + i + ")'></td>";
        str += "<td class='map_i2c'><input id=p" + i + "_i2c_max type='number' class='param_v' size=6 min='-32768' max='32767' onchange='mapping_i2c_max(" + i + ")'></td>";

        // Add UI Builder controls
        str += "<td class='map_ui_lua'><select id=p" + i + "_ui_controller onchange='ui_controller_change(" + i + ")'>";
        str += "<option value=''>None</option>";
        // Buttons (1-3 only)
        for (let j=1; j<=3; j++) {
            str += "<option value='button" + j + "Push'>Button " + j + " Push</option>";
            str += "<option value='button" + j + "Release'>Button " + j + " Release</option>";
        }
        // Pots
        for (let j=1; j<=3; j++) {
            str += "<option value='pot" + j + "Push'>Pot " + j + " Push</option>";
            str += "<option value='pot" + j + "Release'>Pot " + j + " Release</option>";
            str += "<option value='pot" + j + "'>Pot " + j + "</option>";
        }
        // Encoders
        for (let j=1; j<=2; j++) {
            str += "<option value='encoder" + j + "Push'>Encoder " + j + " Push</option>";
            str += "<option value='encoder" + j + "Release'>Encoder " + j + " Release</option>";
            str += "<option value='encoder" + j + "'>Encoder " + j + "</option>";
        }
        str += "</select></td>";
        
        str += "<td class='map_ui_lua'><input id=p" + i + "_ui_nickname type='text' class='param_v' onchange='ui_nickname_change(" + i + ")'></td>";
        str += "<td class='map_ui_lua'><input id=p" + i + "_ui_min type='number' class='param_v' size=6 onchange='ui_min_change(" + i + ")'></td>";
        str += "<td class='map_ui_lua'><input id=p" + i + "_ui_max type='number' class='param_v' size=6 onchange='ui_max_change(" + i + ")'></td>";
        str += "<td class='map_ui_lua'><input id=p" + i + "_ui_invert type='checkbox' onchange='ui_invert_change(" + i + ")'></td>";

        str += "</tr>";
    }
    str += "</tbody></table>";
    document.getElementById( "parameters" ).innerHTML = str;
    nextParameterToGet = 0;
    numParametersToGet = num;
    setTimeout( getNextParameter, 20 );

    let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
    let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x44, selectedSlot, 0xF7 ];
    output.send( arr );
    let dd = log( "sent parameter values request to disting NT" );
    dumpSysex( arr, "txSysex", dd+"\n" );

    refreshMappingVisibility();
    mappingRefreshed = false;
    if ( anyMappingVisible() ) {
        requestMapping();
    }

    // Set the flag when parameters are loaded
    parametersLoaded = true;
    
    // Check if UI Builder is visible and maintain its state
    if (document.getElementById('show_ui_lua').checked) {
        showUIBuilderColumns();
        loadLuaParams();
    }
    
    // Always update the script after parameters are loaded
    setTimeout(() => {
        updateLuaScript();
    }, 100);
}

// Add function to show UI Builder columns
function showUIBuilderColumns() {
    const elements = document.querySelectorAll('.map_ui_lua');
    elements.forEach(element => {
        element.style.display = 'table-cell';
    });
}

// Modify toggleUILua function
function toggleUILua() {
    const show = document.getElementById('show_ui_lua').checked;
    const elements = document.querySelectorAll('.map_ui_lua');
	const uiBuilder = document.querySelector('.lua-editor');

    elements.forEach(element => {
        element.style.display = show ? 'table-cell' : 'none';
    });
    
    uiBuilder.style.display = show ? 'inline' : 'none';
    
    if (show) {
        loadLuaParams();
    }
    updateLuaScript();
}

// Modify changeSlot function
function changeSlot() {
    parametersLoaded = false;
    initView();

	let slot = selectedSlot; // 0-based

    request();
}

function initView() {
  document.getElementById( "slot_algorithm_name" ).innerHTML = '<i>Add an algorithm...</i>';
  document.getElementById( "parameters" ).innerHTML = '';
}

nextMappingToGet = 0;
numMappingsToGet = 0;
function getNextMapping() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x4B, selectedSlot, (nextMappingToGet>>14)&3, (nextMappingToGet>>7)&0x7f, nextMappingToGet&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent mapping request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	nextMappingToGet += 1;
	if ( nextMappingToGet >= numMappingsToGet ) {
		return;
	}
	setTimeout( getNextMapping, 20 );
}

function requestMapping() {
	nextMappingToGet = 0;
	numMappingsToGet = numParameters;
	setTimeout( getNextMapping, 20 );
}

function extractShort( data ) {
	var v = ( data[0] << 14 ) | ( data[1] << 7 ) | ( data[2] );
	v = ( v << 16 ) >> 16;
	return v;
}

function processParameterInfo( data ) {
	var p = extractShort( data.slice( 0, 3 ) );
	var min = extractShort( data.slice( 3, 6 ) );
	var max = extractShort( data.slice( 6, 9 ) );
	var def = extractShort( data.slice( 9, 12 ) );
	var unit = data[12];
	var name = "";
	for ( var i = 0; i < 24; ++i ) {
		var n = data[13+i];
		if ( n == 0 ) {
			break;
		}
		name += String.fromCharCode( n );
	}
	if ( name.length == 0 ) {
		document.getElementById( "row" + p ).style='display:none;';
	}
	document.getElementById( "p" + p + "_min" ).innerHTML = min;
	document.getElementById( "p" + p + "_max" ).innerHTML = max;
	document.getElementById( "p" + p + "_def" ).innerHTML = def;
	var unitStr = "";
	if ( unit < 1 && min == 0 && max == 1 ) {
		var e = document.getElementById( "p" + p + "_c" );
		var v = document.getElementById( "p" + p + "_s" ).value;
		e.checked = v != 0;
		e.style = 'display:inline;';
	} else if ( unit == 1 ) {
		let slot = selectedSlot
		let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x49, slot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 0xF7 ];
		output.send( arr );
		let dd = log( "sent enum string request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	} else if ( unit == 13 || unit == 14 || unit == 17 ) {
		unitStr = "<br>";
		setTimeout( requestParameterValueString, 1000, p );
	} else if ( unit > 0 && (unit-1) < unitStrings.length ) {
		unitStr = unitStrings[ unit-1 ];
	}
	document.getElementById( "p" + p + "_unit" ).innerHTML = unitStr;
	document.getElementById( "p" + p + "_name" ).innerHTML = name;
	var s = document.getElementById( "p" + p + "_s" );
	s.min = min;
	s.max = max;
}

function processAllParameterValues( data ) {
	var p;
	var num = data.length / 3;
	var c = 0;
	for ( p=0; p<num; ++p ) {
		var v = extractShort( data.slice( c, c+3 ) );
		c += 3;
		if ( document.getElementById( "p" + p + "_v" ) == null ) {
			continue;
		}
		document.getElementById( "p" + p + "_v" ).value = v;
	    document.getElementById( "p" + p + "_s" ).value = v;
	    document.getElementById( "p" + p + "_e" ).value = v;
	    document.getElementById( "p" + p + "_c" ).checked = v;
	}
}

function processParameterValue( data ) {
	let p = extractShort( data.slice( 0, 3 ) );
	let v = extractShort( data.slice( 3, 6 ) );
    document.getElementById( "p" + p + "_v" ).value = v;
    document.getElementById( "p" + p + "_s" ).value = v;
    document.getElementById( "p" + p + "_e" ).value = v;
    document.getElementById( "p" + p + "_c" ).checked = v;
}

function processParameterValueString( data ) {
	let p = extractShort( data.slice( 0, 3 ) );
	let name = "";
	for ( let i = 0; i < 32; ++i ) {
		let n = data[3+i];
		if ( n == 0 ) {
			break;
		}
		name += String.fromCharCode( n );
	}
    document.getElementById( "p" + p + "_pv" ).innerHTML = name;
}

function requestParameterValue( p ) {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x45, selectedSlot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent parameter value request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function requestParameterValueString( p ) {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x50, selectedSlot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent parameter value string request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function send_preset_name() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x47 ];
	let name = document.getElementById( "preset_name" ).value.trim();
	for ( let i = 0; i < name.length; ++i ) {
		arr.push( name.charCodeAt( i ) );
	}
	arr.push( 0x00 );
	arr.push( 0xF7 );
	output.send( arr );
	let dd = log( "sent preset name update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	
	// Load any existing UI params for this preset
	loadLuaParams();
}

function sendSetValue( p, v ) {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x46, selectedSlot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, (v>>14)&3, (v>>7)&0x7f, v&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent parameter update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	setTimeout( requestParameterValue, 5, p );
	let unitStr = document.getElementById( "p" + p + "_unit" ).innerHTML;
	if ( unitStr == "<br>" ) {
		setTimeout( requestParameterValueString, 10, p );
	}
}

function param_def( p ) {
	var v = document.getElementById( "p" + p + "_def" ).innerHTML;
	sendSetValue( p, v );
}

function param_slider( p ) {
	var v = document.getElementById( "p" + p + "_s" ).value;
	sendSetValue( p, v );
}

function param_enum( p ) {
	var v = document.getElementById( "p" + p + "_e" ).value;
	sendSetValue( p, v );
}

function param_check( p ) {
	var v = document.getElementById( "p" + p + "_c" ).checked;
	sendSetValue( p, v );
}

function param_text( p ) {
	var v = document.getElementById( "p" + p + "_v" ).value;
	sendSetValue( p, v );
}

function param_focus( p ) {
	if ( document.getElementById( 'auto_focus' ).checked ) {
		let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x4A, selectedSlot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 0xF7 ];
		output.send( arr );
		let dd = log( "sent focus update to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	}
}

function mapping_send( p ) {
	let input = document.getElementById( "p" + p + "_cv_input" ).value;
	let cv_uni = document.getElementById( "p" + p + "_cv_uni" ).checked;
	let cv_gate = document.getElementById( "p" + p + "_cv_gate" ).checked;
	let flags = cv_uni | ( cv_gate << 1 );
	let volts = document.getElementById( "p" + p + "_cv_volts" ).value;
	let delta = document.getElementById( "p" + p + "_cv_delta" ).value;

	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x4D, selectedSlot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 1, input, flags, volts, (delta>>14)&3, (delta>>7)&0x7f, delta&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent CV mapping update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function style_cv_input( p ) {
	let e = document.getElementById( "p" + p + "_cv_input" );
	let v = e.value;
	e.style.background = v > 0 ? "chartreuse" : "";
}

function mapping_cv_input( p ) {
	style_cv_input( p );
	mapping_send( p );
}
function mapping_cv_uni( p ) {
	mapping_send( p );
}
function mapping_cv_gate( p ) {
	mapping_send( p );
}
function mapping_cv_scale( p ) {
	mapping_send( p );
}
function mapping_cv_volts( p ) {
	mapping_send( p );
}
function mapping_cv_delta( p ) {
	mapping_send( p );
}

function mapping_midi( p ) {
	let ch = document.getElementById( "p" + p + "_midi_ch" ).value;
	let cc = document.getElementById( "p" + p + "_midi_cc" ).value;
	let en = document.getElementById( "p" + p + "_midi_en" ).checked;
	let sym = document.getElementById( "p" + p + "_midi_sym" ).checked;
	let flags = en | ( sym << 1 ) | ( ( ch & 0xf ) << 3 );
	let min = document.getElementById( "p" + p + "_midi_min" ).value;
	let max = document.getElementById( "p" + p + "_midi_max" ).value;

	if ( cc == 128 ) {
		cc = 0;
		flags |= (1<<2);
	}

	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x4E, selectedSlot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 1, cc, flags, (min>>14)&3, (min>>7)&0x7f, min&0x7f, (max>>14)&3, (max>>7)&0x7f, max&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent midi mapping update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function mapping_midi_ch( p ) {
	mapping_midi( p );
}
function mapping_midi_cc( p ) {
	mapping_midi( p );
}
function mapping_midi_en( p ) {
	mapping_midi( p );
}
function mapping_midi_sym( p ) {
	mapping_midi( p );
}
function mapping_midi_min( p ) {
	mapping_midi( p );
}
function mapping_midi_max( p ) {
	mapping_midi( p );
}

function mapping_i2c( p ) {
	let cc = document.getElementById( "p" + p + "_i2c_cc" ).value;
	let en = document.getElementById( "p" + p + "_i2c_en" ).checked;
	let sym = document.getElementById( "p" + p + "_i2c_sym" ).checked;
	let flags = en | ( sym << 1 );
	let min = document.getElementById( "p" + p + "_i2c_min" ).value;
	let max = document.getElementById( "p" + p + "_i2c_max" ).value;

	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x4F, selectedSlot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 1, cc, flags, (min>>14)&3, (min>>7)&0x7f, min&0x7f, (max>>14)&3, (max>>7)&0x7f, max&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent midi mapping update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function mapping_i2c_cc( p ) {
	mapping_i2c( p );
}
function mapping_i2c_en( p ) {
	mapping_i2c( p );
}
function mapping_i2c_sym( p ) {
	mapping_i2c( p );
}
function mapping_i2c_min( p ) {
	mapping_i2c( p );
}
function mapping_i2c_max( p ) {
	mapping_i2c( p );
}

function ui_controller_change(p) {
    let controller = document.getElementById("p" + p + "_ui_controller").value;
    if (!controller) {
        // Clear all settings for this parameter when None is selected
        document.getElementById("p" + p + "_ui_min").value = '';
        document.getElementById("p" + p + "_ui_max").value = '';
        document.getElementById("p" + p + "_ui_invert").checked = false;
        document.getElementById("p" + p + "_ui_nickname").value = '';
    } else {
        // Get parameter min/max values
        let paramMin = parseInt(document.getElementById("p" + p + "_min").innerHTML);
        let paramMax = parseInt(document.getElementById("p" + p + "_max").innerHTML);
        
        // Set default min/max if not set
        let minInput = document.getElementById("p" + p + "_ui_min");
        let maxInput = document.getElementById("p" + p + "_ui_max");
        
        if (!minInput.value) minInput.value = paramMin;
        if (!maxInput.value) maxInput.value = paramMax;
        
        // Set input ranges
        minInput.min = paramMin;
        minInput.max = paramMax;
        maxInput.min = paramMin;
        maxInput.max = paramMax;
    }
    saveLuaParams();
    updateLuaScript();
}

let drawCommands = [];
let highlightedParamIndex = null;

// Functions to render preview

function togglePreview() {
    renderPreview();
}

function renderPreview() {
    const showPreview = document.getElementById('show_preview').checked;
    const canvas = document.getElementById('previewCanvas');
    if (!showPreview) {
        // If preview is not enabled, hide canvas and return
        canvas.style.display = 'none';
        return;
    }

    canvas.style.display = 'block';
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.fillStyle = 'rgb(0,0,0)';
	ctx.fillRect(0,0,256,64);

    drawCommands.forEach(cmd => {
		let baseColor = 'cyan';

		// If this command links to a parameter and that parameter is highlighted, change its color
		if (highlightedParamIndex !== null && cmd.paramIndex === highlightedParamIndex) {
			baseColor = 'rgb(255,0,0)'; // Highlight color (red)
		}

		ctx.fillStyle = baseColor;
		ctx.strokeStyle = baseColor;
		ctx.font = "8px monospace";

        switch (cmd.type) {
            case 'text':
                ctx.fillText(cmd.text, cmd.x, cmd.y);
                break;
            case 'line':
                ctx.beginPath();
                ctx.moveTo(cmd.x1, cmd.y1);
                ctx.lineTo(cmd.x2, cmd.y2);
                ctx.stroke();
                break;
            case 'box':
                ctx.fillRect(cmd.x1, cmd.y1, cmd.x2 - cmd.x1, cmd.y2 - cmd.y1);
                break;
            case 'rectangle':
                ctx.strokeRect(cmd.x1, cmd.y1, cmd.x2 - cmd.x1, cmd.y2 - cmd.y1);
                break;
            // Add other drawing types if needed
        }
    });
}

function updateLuaScript() {
	const NO_SCRIPT_MESSAGES = {
    NO_PRESET_NAME: "-- No preset name set",
    NO_PARAMS: "-- No parameters mapped.",
    ERROR_GENERATING: "-- Error generating script.",
	INVALID_PARAMS: "-- Invalid parameter data.",
	NO_NICKNAME: "-- A nickname is required for any parameter that has a controller selected. \n-- Please add a nickname and try again."
	};

	function shouldDisableDownloadButton() {
		let luaScript = document.getElementById('luaScript').value;
		let isNoScript = Object.values(NO_SCRIPT_MESSAGES).some(msg => luaScript.includes(msg));
		document.getElementById('downloadLuaBtn').disabled = isNoScript;
	}

    let presetName = (document.getElementById('preset_name').value || 'Unnamed').trim();
    if (!presetName) {
        console.warn('No preset name set');
        document.getElementById('luaScript').value = NO_SCRIPT_MESSAGES.NO_PRESET_NAME;
		shouldDisableDownloadButton();
        return;
    }

    let storageKey = 'lua_params_' + presetName;
    let paramsJson = localStorage.getItem(storageKey);
    if (!paramsJson) {
        document.getElementById('luaScript').value = NO_SCRIPT_MESSAGES.NO_PARAMS;
        drawCommands = [];
        renderPreview();
		shouldDisableDownloadButton();
        return;
    }

    try {
        let allSlotParams = JSON.parse(paramsJson);
        if (!allSlotParams || typeof allSlotParams !== 'object') {
            document.getElementById('luaScript').value = NO_SCRIPT_MESSAGES.INVALID_PARAMS;
            drawCommands = [];
            renderPreview();
			shouldDisableDownloadButton();
            return;
        }

        // Flatten all parameters from all slots
        let globalParamList = [];
        Object.keys(allSlotParams).forEach(slot => {
            let slotParams = allSlotParams[slot];
            if (Array.isArray(slotParams)) {
                slotParams.forEach(sp => {
                    // Store the 1-based slot index
                    sp.slotIndex = parseInt(slot) + 1;
                });
                globalParamList = globalParamList.concat(slotParams);
            }
        });

		for (let param of globalParamList) {
        if (param.controllerType && param.controllerType !== '') {
            if (!param.nickname || param.nickname.trim() === '') {
                document.getElementById('luaScript').value = NO_SCRIPT_MESSAGES.NO_NICKNAME;
                drawCommands = [];
                renderPreview();
                shouldDisableDownloadButton();
                return;
            }
			}
		}

        // Limit to 12 parameters for the 3x4 grid
        let maxDisplayParams = Math.min(globalParamList.length, 12);

        // Arrays to hold script code segments
        let script = [];
        let localVars = [];
        let initCode = [];
        let controllerFuncs = [];
        let drawCalls = [];
        let controllerGroups = {};

        // Prepare drawCommands array for the preview
        drawCommands = []; // Clear before rebuilding

        // Basic layout and utility functions for 3x4 grid
        script.push('-- Layout constants for a 3x4 grid');
        script.push('local COL1_X, COL2_X, COL3_X = 10, 74, 138');
        script.push('local ROW1_Y, ROW2_Y, ROW3_Y, ROW4_Y = 20, 35, 50, 65');
        script.push('');
        script.push('-- Utility functions');
        script.push('local function to_db(normalized)');
        script.push('    return -70 + (normalized * 76)  -- Scale to -70dB to +6dB');
        script.push('end');
        script.push('');
        script.push('-- Helper function for enums');
        script.push('local function getEnumText(options, index)');
        script.push('    if options and options[index + 1] then');
        script.push('        return options[index + 1]');
        script.push('    end');
        script.push('    return tostring(index)');
        script.push('end');
        script.push('');

        // Prepare parameter variables and init lines
        for (let i = 0; i < maxDisplayParams; i++) {
            let param = globalParamList[i];
            let nickname = param.nickname || param.name.toLowerCase().replace(/\s+/g, '_');
            let paramIndex = param.paramIndex + 1;
            let slotIndex = param.slotIndex || 1;

            localVars.push(`local ${nickname}_value = 0`);

            if (param.allControlOptions && param.allControlOptions.length > 0) {
                // Enum parameter
                localVars.push(`local ${nickname}_options = {${param.allControlOptions.map(opt => `"${opt}"`).join(',')}}`);
                initCode.push(`    do`);
                initCode.push(`        local raw = getParameter(${slotIndex}, ${paramIndex})`);
                initCode.push(`        ${nickname}_value = raw`);
                initCode.push(`    end`);
            } else {
                // Normal parameter
                initCode.push(`    do`);
                initCode.push(`        local raw = getParameter(${slotIndex}, ${paramIndex})`);
                initCode.push(`        local pmin = ${param.min}`);
                initCode.push(`        local pmax = ${param.max}`);
                initCode.push(`        local normalized = 0`);
                initCode.push(`        if pmax > pmin then`);
                initCode.push(`            normalized = (raw - pmin) / (pmax - pmin)`);
                initCode.push(`        end`);
                initCode.push(`        ${nickname}_value = normalized`);
                initCode.push(`    end`);
            }
        }

        // Group parameters by controller
        globalParamList.forEach(param => {
            let controllerKey = param.controllerType;
            if (!controllerKey || controllerKey === '') return;
            if (!controllerGroups[controllerKey]) {
                controllerGroups[controllerKey] = [];
            }
            controllerGroups[controllerKey].push(param);
        });

        function transformControllerName(name) {
            if (name.endsWith('Push') || name.endsWith('Release')) {
                return name;
            }
            return name + 'Turn';
        }

        function isPotController(name) {
            return name.startsWith('pot') && name.endsWith('Turn');
        }

        Object.entries(controllerGroups).forEach(([controller, params]) => {
            let luaFunctionName = transformControllerName(controller);
            let isEncoder = luaFunctionName.startsWith('encoder') && luaFunctionName.endsWith('Turn');
            let isPot = isPotController(luaFunctionName);

            let numParams = params.length;

            if (luaFunctionName.endsWith('Push') || luaFunctionName.endsWith('Release')) {
                // Buttons
                controllerFuncs.push(`    ${luaFunctionName} = function()`);
                params.forEach(p => {
                    let nickname = p.nickname || p.name.toLowerCase().replace(/\s+/g, '_');
                    if (p.allControlOptions && p.allControlOptions.length > 0) {
                        // Enum cycle
                        controllerFuncs.push(`        ${nickname}_value = (${nickname}_value + 1) % ${p.allControlOptions.length}`);
                        controllerFuncs.push(`        setParameter(${p.slotIndex}, ${p.paramIndex + 1}, ${nickname}_value)`);
                    } else {
                        // Toggle
                        controllerFuncs.push(`        ${nickname}_value = ${nickname}_value == 1 and 0 or 1`);
                        controllerFuncs.push(`        setParameterNormalized(${p.slotIndex}, ${p.paramIndex + 1}, ${nickname}_value)`);
                    }
                });
                controllerFuncs.push(`    end,`);
            } else if (isEncoder) {
                // Encoder
                controllerFuncs.push(`    ${luaFunctionName} = function(direction)`);
                params.forEach(p => {
                    let nickname = p.nickname || p.name.toLowerCase().replace(/\s+/g, '_');
                    let step = p.invert ? `(-direction * 0.01)` : `(direction * 0.01)`;
                    controllerFuncs.push(`        ${nickname}_value = math.max(0, math.min(1, ${nickname}_value + ${step}))`);
                    controllerFuncs.push(`        setParameterNormalized(${p.slotIndex}, ${p.paramIndex + 1}, ${nickname}_value)`);
                });
                controllerFuncs.push(`    end,`);
            } else if (isPot) {
                // Pot with soft takeover
                if (numParams > 1) {
                    controllerFuncs.push(`    ${luaFunctionName} = function(value)`);
                    controllerFuncs.push(`        -- This pot controls multiple parameters`);
                    params.forEach(p => {
                        let nickname = p.nickname || p.name.toLowerCase().replace(/\s+/g, '_');
                        let adjustedVal = p.invert ? `(1 - value)` : `value`;
                        if (p.allControlOptions && p.allControlOptions.length > 0) {
                            controllerFuncs.push(`        local index = math.floor(${adjustedVal} * (${p.allControlOptions.length - 1}))`);
                            controllerFuncs.push(`        ${nickname}_value = index`);
                            controllerFuncs.push(`        setParameter(${p.slotIndex}, ${p.paramIndex + 1}, index)`);
                        } else {
                            controllerFuncs.push(`        ${nickname}_value = ${adjustedVal}`);
                            controllerFuncs.push(`        setParameterNormalized(${p.slotIndex}, ${p.paramIndex + 1}, ${adjustedVal})`);
                        }
                    });
                    controllerFuncs.push(`    end,`);
                } else {
                    let p = params[0];
                    let nickname = p.nickname || p.name.toLowerCase().replace(/\s+/g, '_');
                    let potVar = `${nickname}_last`;
                    let potActiveVar = `${nickname}_active`;

                    localVars.push(`local ${potVar} = -1`);
                    localVars.push(`local ${potActiveVar} = false`);

                    controllerFuncs.push(`    ${luaFunctionName} = function(value)`);
                    controllerFuncs.push(`        if not ${potActiveVar} then`);
                    controllerFuncs.push(`            if math.abs(value - ${nickname}_value) < 0.01 then`);
                    controllerFuncs.push(`                ${potActiveVar} = true`);
                    controllerFuncs.push(`            else`);
                    controllerFuncs.push(`                return`);
                    controllerFuncs.push(`            end`);
                    controllerFuncs.push(`        end`);

                    let adjustedVal = p.invert ? `(1 - value)` : `value`;
                    if (p.allControlOptions && p.allControlOptions.length > 0) {
                        controllerFuncs.push(`        local index = math.floor(${adjustedVal} * (${p.allControlOptions.length - 1}))`);
                        controllerFuncs.push(`        ${nickname}_value = index`);
                        controllerFuncs.push(`        setParameter(${p.slotIndex}, ${p.paramIndex + 1}, index)`);
                    } else {
                        controllerFuncs.push(`        ${nickname}_value = ${adjustedVal}`);
                        controllerFuncs.push(`        setParameterNormalized(${p.slotIndex}, ${p.paramIndex + 1}, ${adjustedVal})`);
                    }

                    controllerFuncs.push(`    end,`);
                }
            } else {
                // Other turn controls
                controllerFuncs.push(`    ${luaFunctionName} = function(value)`);
                params.forEach(p => {
                    let nickname = p.nickname || p.name.toLowerCase().replace(/\s+/g, '_');
                    let adjustedVal = p.invert ? `(1 - value)` : `value`;
                    if (p.allControlOptions && p.allControlOptions.length > 0) {
                        let numOptions = p.allControlOptions.length;
                        controllerFuncs.push(`        local index = math.floor(${adjustedVal} * (${numOptions - 1}))`);
                        controllerFuncs.push(`        ${nickname}_value = index`);
                        controllerFuncs.push(`        setParameter(${p.slotIndex}, ${p.paramIndex + 1}, index)`);
                    } else {
                        controllerFuncs.push(`        ${nickname}_value = ${adjustedVal}`);
                        controllerFuncs.push(`        setParameterNormalized(${p.slotIndex}, ${p.paramIndex + 1}, ${adjustedVal})`);
                    }
                });
                controllerFuncs.push(`    end,`);
            }
        });

        // Build draw calls and also create corresponding drawCommands for preview
        let rowPositions = ['ROW1_Y', 'ROW2_Y', 'ROW3_Y', 'ROW4_Y'];
        let colPositions = ['COL1_X', 'COL2_X', 'COL3_X'];

        for (let i = 0; i < maxDisplayParams; i++) {
            let param = globalParamList[i];
            let nickname = param.nickname || param.name.toLowerCase().replace(/\s+/g, '_');
            let colIndex = i % 3;
            let rowIndex = Math.floor(i / 3);
            let cX = colPositions[colIndex];
            let rY = rowPositions[rowIndex];

            // Determine what text to display
            let displayLine;
            let paramIndexForHighlight = param.paramIndex; // used for highlight
            if (param.allControlOptions && param.allControlOptions.length > 0) {
                drawCalls.push(`    drawText(${cX}, ${rY}, string.format("%s: %s", "${param.nickname.toUpperCase()}", getEnumText(${nickname}_options, ${nickname}_value)))`);
                displayLine = `${param.nickname.toUpperCase()}: [Enum]`;
            } else {
                if (param.unit === 'dB') {
                    drawCalls.push(`    local ${nickname}_db = to_db(${nickname}_value or 0)`);
                    drawCalls.push(`    drawText(${cX}, ${rY}, string.format("%s: %3.1fdB", "${param.nickname.toUpperCase()}", ${nickname}_db))`);
                    displayLine = `${param.nickname.toUpperCase()}: dB value`;
                } else {
                    drawCalls.push(`    local ${nickname}_percent = (${nickname}_value or 0) * 100`);
                    drawCalls.push(`    drawText(${cX}, ${rY}, string.format("%s: %3.1f", "${param.nickname.toUpperCase()}", ${nickname}_percent))`);
                    displayLine = `${param.nickname.toUpperCase()}: % value`;
                }
            }

            // add to drawCommands for preview
            let cXVal = [10, 74, 138][colIndex];
            let rYVal;
            switch (rowIndex) {
                case 0: rYVal = 20; break;
                case 1: rYVal = 35; break;
                case 2: rYVal = 50; break;
                case 3: rYVal = 65; break;
            }

            drawCommands.push({
                type: 'text',
                x: cXVal,
                y: rYVal,
                text: displayLine,
                shade: 15,
                paramIndex: paramIndexForHighlight
            });
        }

        if (globalParamList.length > 12) {
            drawCalls.push(`    -- Note: More than 12 parameters are mapped but only 12 are displayed.`);
            drawCommands.push({
                type: 'text',
                x: 10,
                y: 60,
                text: "Only 12 displayed",
                shade: 8
            });
        }

        // Build final Lua script
        let finalScript = [];
        finalScript.push('return {');
        finalScript.push(`    name = '${presetName} UI script',`);
        finalScript.push(`    author = 'chordsmaze',`);
        finalScript.push(`    description = 'UI script for ${presetName} preset created by the UI Builder by chordsmaze',`);
        finalScript.push('');
        finalScript.push('    init = function()');
        finalScript.push('        -- Get initial parameter values');
        initCode.forEach(line => finalScript.push(line));
        finalScript.push('        return true');
        finalScript.push('    end,');
        finalScript.push('');
        controllerFuncs.forEach(line => finalScript.push(line));
        if (!controllerFuncs.some(c => c.includes('button4Push'))) {
            finalScript.push('    button4Push = function()');
            finalScript.push('        exit()');
            finalScript.push('    end,');
        }
        finalScript.push('');
        finalScript.push('    draw = function()');
        if (drawCalls.length === 0) {
            finalScript.push('        -- No parameters mapped to display');
        } else {
            drawCalls.forEach(line => finalScript.push(line));
        }
        finalScript.push('    end');
        finalScript.push('}');

        let luaScript = script.join('\n') + '\n' + localVars.join('\n') + '\n' + finalScript.join('\n');
        document.getElementById('luaScript').value = luaScript;

        // Render preview after update
        renderPreview();

		shouldDisableDownloadButton();
    } catch (e) {
        console.error('Error generating script:', e);
        document.getElementById('luaScript').value = NO_SCRIPT_MESSAGES.ERROR_GENERATING;
        drawCommands = [];
        renderPreview();
		shouldDisableDownloadButton();
    }
}

function ui_min_change(p) {
    let minInput = document.getElementById("p" + p + "_ui_min");
    let maxInput = document.getElementById("p" + p + "_ui_max");
    let min = parseInt(minInput.value);
    let max = parseInt(maxInput.value);
    
    // Validate min is less than max
    if (min >= max) {
        minInput.value = max - 1;
    }
    
    // Validate within parameter bounds
    let paramMin = parseInt(document.getElementById("p" + p + "_min").innerHTML);
    let paramMax = parseInt(document.getElementById("p" + p + "_max").innerHTML);
    
    if (min < paramMin) minInput.value = paramMin;
    if (min > paramMax) minInput.value = paramMax;
    
    saveLuaParams();
    updateLuaScript();
}

function ui_max_change(p) {
    let minInput = document.getElementById("p" + p + "_ui_min");
    let maxInput = document.getElementById("p" + p + "_ui_max");
    let min = parseInt(minInput.value);
    let max = parseInt(maxInput.value);
    
    // Validate max is more than min
    if (max <= min) {
        maxInput.value = min + 1;
    }
    
    // Validate within parameter bounds
    let paramMin = parseInt(document.getElementById("p" + p + "_min").innerHTML);
    let paramMax = parseInt(document.getElementById("p" + p + "_max").innerHTML);
    
    if (max < paramMin) maxInput.value = paramMin;
    if (max > paramMax) maxInput.value = paramMax;
    
    saveLuaParams();
    updateLuaScript();
}

function ui_invert_change(p) {
    saveLuaParams();
    updateLuaScript();
}

// Add the new function for nickname changes
function ui_nickname_change(p) {
    saveLuaParams();
    updateLuaScript();
}

// Add event listener for preset name changes
document.getElementById('preset_name').addEventListener('change', function() {
    saveLuaParams();
    updateLuaScript();
});

// Add after the existing script functions

function saveLuaParams() {
    let presetName = document.getElementById('preset_name').value.trim();
    let currentSlot = selectedSlot;
    
    if (!presetName) {
        console.warn('No preset name set');
        return;
    }

    let storageKey = 'lua_params_' + presetName;
    let allSlotParams = {};
    try {
        let existing = localStorage.getItem(storageKey);
        if (existing) {
            allSlotParams = JSON.parse(existing);
        }
    } catch (e) {
        console.warn('Error loading existing params:', e);
    }
    
    let slotParams = [];
    
    for (let i = 0; i < numParameters; i++) {
        let controller = document.getElementById('p' + i + '_ui_controller');
        if (controller && controller.value) {
            let parameterControlOptions = document.getElementById('p' + i + '_e');
            let pvString = document.getElementById('p' + i + '_pv');

            let allControlOptions = [];
            for (let option of parameterControlOptions.options) {
                allControlOptions.push(option.text);
            }

            let param = {
                paramIndex: i,
                controllerType: controller.value,
                min: document.getElementById('p' + i + '_ui_min').value,
                max: document.getElementById('p' + i + '_ui_max').value,
                invert: document.getElementById('p' + i + '_ui_invert').checked ? 1 : 0,
				// remove symbols that are not allowed in Lua variable names
                nickname: document.getElementById('p' + i + '_ui_nickname').value.trim().replace(/\/|:/g, ''),
                name: document.getElementById('p' + i + '_name').innerHTML.replace(/\/|:/g, ''),
                unit: document.getElementById('p' + i + '_unit').textContent || '',
                allControlOptions
            };
            slotParams.push(param);
        }
    }
    
    allSlotParams[currentSlot] = slotParams;
    localStorage.setItem(storageKey, JSON.stringify(allSlotParams));
}

function loadLuaParams() {
    let presetName = document.getElementById('preset_name').value.trim();
    let currentSlot = selectedSlot;
    
    if (!presetName) {
        console.warn('No preset name set');
        return;
    }

    let storageKey = 'lua_params_' + presetName;
    let paramsJson = localStorage.getItem(storageKey);
    
    if (paramsJson) {
        try {
            let allSlotParams = JSON.parse(paramsJson);
            let slotParams = allSlotParams[currentSlot] || [];
            
            // Clear all existing UI settings first
            clearLuaParams();
            
            // Apply loaded settings for current slot
            slotParams.forEach(param => {
                if (param.paramIndex < numParameters) {
                    document.getElementById('p' + param.paramIndex + '_ui_controller').value = param.controllerType;
                    document.getElementById('p' + param.paramIndex + '_ui_min').value = param.min;
                    document.getElementById('p' + param.paramIndex + '_ui_max').value = param.max;
                    document.getElementById('p' + param.paramIndex + '_ui_invert').checked = param.invert === 1;
                    document.getElementById('p' + param.paramIndex + '_ui_nickname').value = param.nickname || '';
                }
            });
            
            console.log('Loaded UI params for preset:', presetName, 'slot:', currentSlot);
            
            // Always update the script after loading params
            updateLuaScript();
        } catch (e) {
            console.warn('Error parsing stored params:', e);
        }
    } else {
        // Even if no params for this slot, still update script
        // as there might be params for other slots
        updateLuaScript();
    }
}

function clearLuaParams() {
    // Clear all UI Builder settings
    for (let i = 0; i < numParameters; i++) {
        let controller = document.getElementById('p' + i + '_ui_controller');
        if (controller) {
            controller.value = '';
            document.getElementById('p' + i + '_ui_min').value = '';
            document.getElementById('p' + i + '_ui_max').value = '';
            document.getElementById('p' + i + '_ui_invert').checked = false;
            document.getElementById('p' + i + '_ui_nickname').value = '';
        }
    }
}

function deleteLuaParams() {
  let presetName = document.getElementById('preset_name').value.trim();
  if (!presetName) {
    console.warn('No preset name set; cannot delete mapping.');
    return;
  }
  
  if (!confirm("Are you sure you want to delete all saved mappings for this preset?")) {
    return; // User canceled, do nothing
  }

  let storageKey = 'lua_params_' + presetName;
  localStorage.removeItem(storageKey);
  clearLuaParams();
  updateLuaScript();
  console.log('Mappings deleted for preset:', presetName);
}

// Add function to hide UI Builder columns
function hideUIBuilderColumns() {
    const elements = document.querySelectorAll('.map_ui_lua');
    elements.forEach(element => {
        element.style.display = 'none';
    });
}

// Add function to show UI Builder columns
function showUIBuilderColumns() {
    const elements = document.querySelectorAll('.map_ui_lua');
    elements.forEach(element => {
        element.style.display = 'table-cell';
    });
}

// Update the show_ui_lua change handler
document.getElementById('show_ui_lua').addEventListener('change', function() {
    if (this.checked) {
        showUIBuilderColumns();
        loadLuaParams();
    } else {
        hideUIBuilderColumns();
    }
    updateLuaScript();
});

// download function after the updateLuaScript function
function downloadLuaScript() {
    let presetName = document.getElementById('preset_name').value.trim() || 'unnamed';
    let luaScript = document.getElementById('luaScript').value;
    
    // Create a blob with the script content
    const blob = new Blob([luaScript], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `${presetName}_ui.lua`;
    
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}
</script>

<script>
var midi, data;
const dntMIDIInKey = "dntMIDIInKey";
const dntMIDIOutKey = "dntMIDIOutKey";
const dexSysExKey = "dexSysExKey";
const defaultDntPortName = "disting NT";

var dexInPortName = defaultDntPortName;
var dexOutPortName = defaultDntPortName;
var sysExId ;

if(!localStorage.getItem(dntMIDIInKey)) {  // No input stored
    localStorage.setItem(dntMIDIInKey, defaultDntPortName);
}
else {
    dexInPortName = localStorage.getItem(dntMIDIInKey);
}

if(!localStorage.getItem(dntMIDIOutKey)) {  // No output stored
    localStorage.setItem(dntMIDIOutKey, defaultDntPortName);
}
else {
    dexOutPortName = localStorage.getItem(dntMIDIOutKey);
}

if(!localStorage.getItem(dexSysExKey)) {  // No system exclusive ID stored
    localStorage.setItem(dexSysExKey, 0);
}
else {
    sysExId = localStorage.getItem(dexSysExKey);
}

var sendRTC = true;

if ( navigator.requestMIDIAccess ) {
    navigator.requestMIDIAccess ( {
        sysex: true
    } ).then(onMIDISuccess, onMIDIFailure);
} else {
    status("No MIDI support in your browser.");
}
function onMIDISuccess(midiAccess) {
    midi = midiAccess;
    let str = "";
    let dex = -1;
    let inputs = midi.inputs.values();

    for ( var input = inputs.next(); input && !input.done; input = inputs.next() ) {
	    str += "<option value='" + input.value.id + "'>" + input.value.name + "</option>";
	    if ( input.value.name == dexInPortName ) {
		    dex = input.value.id;
	    }
    }
    document.getElementById( "midiinput" ).innerHTML = str
    if ( dex != -1 ) {
	    document.getElementById( "midiinput" ).value = dex;
    }

    str = "";
    dex = -1;
    let outputs = midi.outputs.values();

    for ( var output = outputs.next(); output && !output.done; output = outputs.next() ) {
	    str += "<option value='" + output.value.id + "'>" + output.value.name + "</option>";
	    if ( output.value.name == dexOutPortName ) {
		    dex = output.value.id;
	    }
    }
    document.getElementById( "midioutput" ).innerHTML = str
    if ( dex != -1 ) {
	    document.getElementById( "midioutput" ).value = dex;
    }

	document.getElementById("sysExId").selectedIndex = sysExId;
	changeInput();

	log( "midi access granted" );
    status("OK");
    initView();

    // Set the selectedSlot from the query string
    let { slot } = getQueryParams();
    if (slot) {
        // Convert from 1-based to 0-based indexing
        selectedSlot = Number(slot) - 1;
        highlightSelectedSlot();
    }

    request();
    
    // Always try to update script after initial load
    setTimeout(() => {
        updateLuaScript();
    }, 1000);
}
function onMIDIFailure(e) {
	log( "midi access failure" );
    status("No access to MIDI devices or your browser doesn't support WebMIDI API.");
}
function changeInput() {
    var inputs = midi.inputs.values();
    for ( var input = inputs.next(); input && !input.done; input = inputs.next() ) {
    	input.value.onmidimessage = "";
    }
	var input = midi.inputs.get( document.getElementById( "midiinput" ).value );
	input.onmidimessage = onMIDIMessage;

	// Save the current port setting
	let inputSelector = document.getElementById("midiinput");
let selectedPortName = inputSelector.options[inputSelector.selectedIndex].text;
    localStorage.setItem(dntMIDIInKey, selectedPortName);
}

function changeOutput() {
let outputSelector = document.getElementById("midioutput");
let selectedPortName = outputSelector.options[outputSelector.selectedIndex].text;
    localStorage.setItem(dntMIDIOutKey, selectedPortName);
    sendRTC = true;
}

function changeSysExId() {
	sysExId = document.getElementById( "sysExId" ).value;
   localStorage.setItem(dexSysExKey, sysExId);
   sendRTC = true;
}

function changeAlgorithm() {
	let index = document.getElementById( 'algorithms_menu' ).value;
	let factory = factories[ index ];
	let numSpecs = factory[ 1 ];
	for ( let i=0; i<3; ++i ) {
		if ( numSpecs > i ) {
			document.getElementById( 'spec' + (i+1) + 'label' ).innerHTML = factory[3][1+i] + ":";
			let t = document.getElementById( 'spec' + (i+1) );
			t.min = factory[2][i][0];
			t.max = factory[2][i][1];
			t.value = factory[2][i][2];
			t.style = 'display:inline;';
		} else {
			document.getElementById( 'spec' + (i+1) + 'label' ).innerHTML = "";
			document.getElementById( 'spec' + (i+1) ).style='display:none;';
		}
	}
}

function addAlgorithm() {
	let index = document.getElementById( 'algorithms_menu' ).value;
	let factory = factories[ index ];
	let guid = factory[ 0 ];
	let numSpecs = factory[ 1 ];
	let specs = [ 0, 0, 0 ];
	for ( let i=0; i<3; ++i ) {
		if ( numSpecs > i ) {
			specs[i] = document.getElementById( 'spec' + (i+1) ).value;
		}
	}
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x32, guid[0], guid[1], guid[2], guid[3], (specs[0]>>14)&3, (specs[0]>>7)&0x7f, specs[0]&0x7f, (specs[1]>>14)&3, (specs[1]>>7)&0x7f, specs[1]&0x7f, (specs[2]>>14)&3, (specs[2]>>7)&0x7f, specs[2]&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent add algorithm request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	changeSlot();
}

function removeAlgorithm() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x33, selectedSlot, 0xF7 ];
	output.send( arr );
	let dd = log( "sent remove algorithm request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	changeSlot();
}

function loadPreset() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let append = 0;
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x34, append ];
	let name = "/presets/Aleatoric Piano.json";
	for ( let i = 0; i < name.length; ++i ) {
		arr.push( name.charCodeAt( i ) );
	}
	arr.push( 0x00 );
	arr.push( 0xF7 );
	output.send( arr );
	let dd = log( "sent load preset request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function newPreset() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x35, 0xF7 ];
	output.send( arr );
	let dd = log( "sent new preset request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function savePreset( option ) {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x36, option, 0xF7 ];
	output.send( arr );
	let dd = log( "sent save preset request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function moveAlgorithmUp() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x37, selectedSlot, selectedSlot-1, 0xF7 ];
	output.send( arr );
	let dd = log( "sent move algorithm request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function changeSlot() {
    parametersLoaded = false;
    initView();
    request();
}

function onMIDIMessage(message) {
    data = message.data;
    let header = [ 240, 0, 33, 39, 0x6D, sysExId ];
    for ( var i=0; i<6; ++i ) {
    	if ( header[i] != data[i] ) {
    		return;
    	}
    }
	let rxSlot = data[7];
	let dd = log( "received sysex (" + data.length + " bytes)" );
	dumpSysex( data, "rxSysex", dd+"\n" );
	if ( data[6] == 0x30 ) {
		processNumAlgorithms( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x31 ) {
		processAlgorithmInfo( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x40 ) {
		if ( routingAnalysisMode || ( rxSlot == selectedSlot ) ) {
			processAlgorithm( rxSlot, data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x41 ) {
    	processPresetName( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x42 ) {
		if ( rxSlot == selectedSlot ) {
			processNumParameters( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x43 ) {
		if ( rxSlot == selectedSlot ) {
			processParameterInfo( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x44 ) {
		if ( rxSlot == selectedSlot ) {
			processAllParameterValues( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x45 ) {
		if ( rxSlot == selectedSlot ) {
			processParameterValue( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x48 ) {
		processUnitStrings( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x49 ) {
		if ( rxSlot == selectedSlot ) {
			processEnumStrings( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x4B ) {
		if ( rxSlot == selectedSlot ) {
			processMapping( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x50 ) {
		if ( rxSlot == selectedSlot ) {
			processParameterValueString( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x60 ) {
		processSlotCount( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x61 ) {
		processRoutingInfo( data.slice( 7, -1 ) );
	}
}

function wake() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x07, 0xF7 ];
	output.send( arr );
	let dd = log( "sent wake request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function refresh() {
	if ( routingAnalysisMode ) {
		requestRouting();
	} else {
		request();
	}
}
function request() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	
	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x52, 0xF7 ];
	output.send( arr );
	var dd = log( "sent algorithm names request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x41, 0xF7 ];
	output.send( arr );
	var dd = log( "sent preset name request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x48, 0xF7 ];
	output.send( arr );
	var dd = log( "sent unit strings request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x42, selectedSlot, 0xF7 ];
	output.send( arr );
	var dd = log( "sent num parameters request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x30, 0xF7 ];
	output.send( arr );
	var dd = log( "sent num algorithms request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	mappingRefreshed = false;
	if ( sendRTC ) {
		sendRTC = false;
		let d = Math.floor( Date.now() / 1000 );
		let n = new Date( Date.now() );
		d -= n.getTimezoneOffset() * 60;
		var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x04,
			(d>>28)&0xf, (d>>21)&0x7f, (d>>14)&0x7f, (d>>7)&0x7f, (d>>0)&0x7f,
			0xF7 ];
		output.send( arr );
		var dd = log( "sent RTC update to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	}
}
function requestRouting() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x60, 0xF7 ];
	output.send( arr );
	var dd = log( "sent slot count request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}
function sendMsg() {
	var str = makeMsgSysEx();
	var arr = new Uint8Array( str.length );
	for ( var i=0; i<str.length; ++i ) {
		arr[i] = str.charCodeAt( i );
	}
	var output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	output.send( arr );
	var dd = log( "sent sysex (" + str.length + " bytes)" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function getQueryParams() {
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const params = {};
    
    for (const [key, value] of urlParams.entries()) {
        if (key === 'slot') {
            // Ensure slot is within valid range (1-32)
            const slotNum = parseInt(value);
            if (slotNum >= 1 && slotNum <= 32) {
                params[key] = slotNum;
            }
        } else {
            params[key] = value;
        }
    }
    
    return params;
}

// Call buildSlotGrid after DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    buildSlotGrid();
});
</script>

</body>
