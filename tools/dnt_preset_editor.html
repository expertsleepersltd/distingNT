<!DOCTYPE html>
<head>

<title>disting NT Preset Editor</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">

<style>
body {
	font-family: 'PT Sans', serif;
}
button {
	font-family: 'PT Sans', serif;
}
button.big {
	font-size: 120%;
}
select {
	font-family: 'PT Sans', serif;
}
div.small {
	font-size: 80%;
}
td.tc {
	text-align: center;
	background-color: #c0c0c0;
	font-size: 80%;
}
tr.a {
	background-color: #e0e0e0;
}
th {
	background-color: #c0c0c0;
	font-size: 80%;
}
textarea {
    font-family: monospace;
}
input.param_v {
	width: 50px;
}
input.param_s {
	width: 400px;
	height: 10px;
	-webkit-appearance: none;
	background-color: #f0f0f0;
	-webkit-border-radius: 20px;
}
button.param_def {
	width: 40px;
}
div.pv_string {
	display: inline;
}
.hidden {
	position:absolute;
	left:-10000px;
	top:auto;
	width:1px;
	height:1px;
	overflow:hidden;
}
th.routingI {
	text-align: center;
	width: 2em;
	background-color: #c0c0c0;
}
th.routingO {
	text-align: center;
	width: 2em;
	background-color: #e0e0e0;
}
th.routingA {
	text-align: center;
	width: 2em;
	background-color: #c0c0c0;
}
td.routing {
	text-align: center;
}
td.routingL {
	text-align: center;
    border-left: thin;
    border-left-style: dashed;
    border-color: #808080;
}
td.routingSlotName {
	text-align: center;
	background-color: #f0f0f0;
	white-space: nowrap;
}
td.routingSlot {
	text-align: center;
}
button.moveSlot {
	width : 1em;
	padding : 0;
}
</style>

<script>
function log( t ) {
	if ( !document.getElementById( "show_log" ).checked ) {
		return;
	}
	var ta = document.getElementById( "log" );
	var d = new Date();
	var dd = d.toLocaleTimeString();
	ta.value = ta.value + "\n" + dd + ": " + t;
	ta.scrollTop = ta.scrollHeight;
	return dd;
}
function status( t ) {
    document.getElementById( "status" ).innerHTML = "Web MIDI status: " + t;
}
function nybbleChar( n ) {
	if ( n >= 10 ) {
		return String.fromCharCode( 'A'.charCodeAt( 0 ) + n - 10 );
	}
	return String.fromCharCode( '0'.charCodeAt( 0 ) + n );
}
function makeMsgSysEx() {
	var d = [0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x02]
	var len = d.length
	var str = ""
	for ( var i = 0; i < len; ++i ) {
		str += String.fromCharCode( d[i] );
	}
	var text = "Hello!\nThis message\nwas sent from\nthe config tool.";
	str += text;
	str += String.fromCharCode( 0xF7 );
	return str;
}
function dumpSysex( data, id, prefix ) {
	if ( !document.getElementById( "show_log" ).checked ) {
		return;
	}
	let len = data.length
	let h = prefix
	for ( let i = 0; i < len; ++i ) {
		let b = data[ i ];
		h += nybbleChar( b >> 4 );
		h += nybbleChar( b & 0xf );
		h += " ";
		if ( ( i & 0xf ) === 0xf ) {
			h += "\n";
		}
	}
	if ( document.getElementById( 'keep_log').checked ) {
		h += "\n";
		document.getElementById( id ).value += h;
	}
	else {
		document.getElementById( id ).value = h;
	}
}
</script>

</head>

<body>

<div class="small">
At the time of writing this will work only in Google's <a href="http://www.google.com/chrome/">Chrome</a> browser. Chrome may block SysEx access if you run this from a website, in which case download the html file locally and run it from there.
</div>
<div class="small" id="status"></div>
<p>

<!--<button  accesskey="s" onclick="sendMsg()">Send Msg</button>-->
<button class="big"  accesskey="r" onclick="refresh()">Refresh</button>
<label for="midioutput">Send to MIDI port:</label>
<select id="midioutput"  onchange='changeOutput()' accesskey="o"></select>
<label for="midiinput">Listen on MIDI port: </label>
<select id="midiinput"  accesskey="i" onchange='changeInput()'></select>
<label for="sysExId">SysEx ID: </label>
<select id="sysExId" onchange='changeSysExId()' accesskey="s">
<script>
for ( let i=0; i<127; ++i ) {
	document.write( "<option value=" + i + ">" + i + "</option>" );
}
</script>
</select>
<label for="slot">Slot: </label>
<select id="slot" onchange='changeSlot()'>
<script>
for ( let i=0; i<32; ++i ) {
	document.write( '<option value=' + i + '>' + (i+1) + '</option>' );
}
</script>
</select>
<label for="show_log">Log:</label><input id='show_log' type='checkbox' onchange='showLog()'>
<label for="keep_log">Keep full log:</label><input id='keep_log' type='checkbox'>
<label for="show_cpu">Show CPU:</label><input id='show_cpu' type='checkbox' onchange='showCPU()'>
<button onclick="wake()">Wake</button>
<p>
<label class="hidden" for="log">Log:</label><textarea rows=5 cols=50 id="log" accesskey="l" class="log" readOnly></textarea>
<label class="hidden" for="txSysex">SysEx sent:</label><textarea rows=5 cols=45 name="text" id="txSysex" accesskey="y" class="log"></textarea>
<label class="hidden" for="rxSysex">SysEx received:</label><textarea rows=5 cols=45 name="text" id="rxSysex" accesskey="x" class="log"></textarea>
</p>

<button class="big" onclick="showSlotEditor()">Edit parameters</button>
<button class="big" onclick="showRoutingAnalysis()">Show routing</button>
Module display mode:
<button onclick="setDisplayMode(0)">Parameters</button>
<button onclick="setDisplayMode(1)">Algorithm UI</button>
<button onclick="setDisplayMode(2)">Overview</button>
<button onclick="setDisplayMode(3)">Overview VUs</button>
<div id='cpu_usage'></div>
<hr>

<div id=slotEditor>

<!--
<button onclick='loadPreset()'>Load</button>
<button onclick='newPreset()'>New</button>
<button onclick='savePreset(0)'>Save (prompt)</button>
<button onclick='savePreset(1)'>Save (safe)</button>
<button onclick='savePreset(2)'>Save (force)</button>
-->
<label for="algorithms_menu">Algorithms:</label>
<select id="algorithms_menu" onchange='changeAlgorithm()'></select>
<label id='spec1label' for="spec1"></label>
<input id='spec1' type='number'></input>
<label id='spec2label' for="spec2"></label>
<input id='spec2' type='number'></input>
<label id='spec3label' for="spec3"></label>
<input id='spec3' type='number'></input>
<button id='addAlgorithmButton' onclick='addAlgorithm()'>Add</button>
<button id='loadPluginButton' onclick='loadPlugin()'>Load</button>
<p>
<label for="auto_focus">Auto-focus:</label><input id='auto_focus' type='checkbox' checked accesskey="u">
<label for="show_mapping_cv">Show CV mappings:</label>
<input id='show_mapping_cv' type='checkbox' accesskey="c" onchange="toggleMappings('cv')">
<label for="show_mapping_midi">Show MIDI mappings:</label>
<input id='show_mapping_midi' type='checkbox' accesskey="m" onchange="toggleMappings('midi')">
<label for="show_mapping_i2c">Show I2C mappings:</label>
<input id='show_mapping_i2c' type='checkbox' accesskey="2" onchange="toggleMappings('i2c')">
<label for="show_pages">Show as:</label>
<select id="show_pages" onchange='changePages()'><option value='false'>Flat list</option><option value='true'>Pages</option></select>
<br>
<label for="preset_name">Preset name:</label><input id='preset_name' accesskey='p' type='text' onchange='send_preset_name()'>
<p>
<h2 id='slot_algorithm_name'></h2>
<label for="slot_name">Custom name:</label><input id='slot_name' type='text' onchange='send_slot_name()'>
<p>
<button id='removeAlgorithmButton' onclick='removeAlgorithm()'>Remove</button>
<p>
<div id='parameters'></div>

</div> <!--slotEditor-->

<div id=routingAnalysis>

<label for="show_signals">Show signals:</label><input id='show_signals' type='checkbox' onchange="buildRoutingInfo()" checked>
<label for="show_mappings">Show mappings:</label><input id='show_mappings' type='checkbox' onchange="buildRoutingInfo()" checked>
<label for="routing_colour1">Colour 1:</label><input id='routing_colour1' type='color' onchange='buildRoutingInfo()'>
<label for="routing_colour2">Colour 2:</label><input id='routing_colour2' type='color' onchange='buildRoutingInfo()'>

<div id=routingAnalysisContent></div>

</div> <!--routingAnalysis-->

<script>
const dntRoutingColour1Key = "dntRoutingColour1";
const dntRoutingColour2Key = "dntRoutingColour2";

if ( !localStorage.getItem( dntRoutingColour1Key ) ) {
    localStorage.setItem( dntRoutingColour1Key, "#b3fff0" );
}
if ( !localStorage.getItem( dntRoutingColour2Key ) ) {
    localStorage.setItem( dntRoutingColour2Key, "#d9ffb3" );
}
document.getElementById( 'routing_colour1' ).value = localStorage.getItem( dntRoutingColour1Key );
document.getElementById( 'routing_colour2' ).value = localStorage.getItem( dntRoutingColour2Key );

var routingAnalysisMode = false;
function showSlotEditor() {
	routingAnalysisMode = false;
	document.getElementById( "routingAnalysis" ).style.display = "none";
	request();
	document.getElementById( "slotEditor" ).style.display = "inline";
}
function showRoutingAnalysis() {
	routingAnalysisMode = true;
	document.getElementById( "slotEditor" ).style.display = "none";
	requestRouting();
	document.getElementById( "routingAnalysis" ).style.display = "inline";
}
document.getElementById( "routingAnalysis" ).style.display = "none";

const dntLogKey = "dntShowLog";

function updateLogVisibility() {
	let vis = document.getElementById( "show_log" ).checked ? "inline" : "none";
	let elts = document.getElementsByClassName( 'log' );
	for ( let e of elts ) {
    	e.style.display = vis;
	}
}

function showLog() {
	updateLogVisibility();
    localStorage.setItem( dntLogKey, document.getElementById( "show_log" ).checked );
}

if ( !localStorage.getItem( dntLogKey ) ) {
    localStorage.setItem( dntLogKey, 1 );
}
document.getElementById( 'show_log' ).checked = ( localStorage.getItem( dntLogKey ) != 'false' );
updateLogVisibility();

const dntCPUKey = "dntShowCPU";

function updateCPUVisibility() {
	let show = document.getElementById( "show_cpu" ).checked;
	document.getElementById( "cpu_usage" ).style.display = show ? "inline" : "none";
	if ( show ) {
		setTimeout( getCPU, 10 );
	}
}

function showCPU() {
	updateCPUVisibility();
    localStorage.setItem( dntCPUKey, document.getElementById( "show_cpu" ).checked );
}

if ( !localStorage.getItem( dntCPUKey ) ) {
    localStorage.setItem( dntCPUKey, 1 );
}
document.getElementById( 'show_cpu' ).checked = ( localStorage.getItem( dntCPUKey ) != 'false' );

function getCPU() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x62, 0xF7 ];
	output.send( arr );
	let dd = log( "sent CPU usage request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	if ( document.getElementById( "show_cpu" ).checked ) {
		setTimeout( getCPU, 1000 );
	}
}

function setDisplayMode( m ) {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x20, m, 0xF7 ];
	output.send( arr );
	let dd = log( "sent display mode to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function lookupGuid( guid ) {
	for ( let i=0; i<numAlgorithms; ++i ) {
		if ( guid[0] == factories[i][0][0] && guid[1] == factories[i][0][1] && guid[2] == factories[i][0][2] && guid[3] == factories[i][0][3] ) {
			return i;
		}
	}
	return -1;
}

function processAlgorithm( slot, data ) {
	let guid = data.slice( 0, 4 );
	let f = lookupGuid( guid );
	if ( f >= 0 ) {
		if ( routingAnalysisMode ) {
			guids[ slot ] = f;
		} else {
			document.getElementById( "slot_algorithm_name" ).innerHTML = factories[f][3][0];
		}
	}
	let name = "";
	for ( let i = 0; i < 24; ++i ) {
		let n = data[4+i];
		if ( n == 0 ) {
			break;
		}
		name += String.fromCharCode( n );
	}
	if ( routingAnalysisMode ) {
		slotNames[ slot ] = name;
	} else {
		document.getElementById( "slot_name" ).value = name;
	}
}

function processPresetName( data ) {
	var name = "";
	for ( var i = 0; i < 21; ++i ) {
		var n = data[i];
		if ( n == 0 ) {
			break;
		}
		name += String.fromCharCode( n );
	}
	document.getElementById( "preset_name" ).value = name;
}

var numAlgorithms = 0;

function processNumAlgorithms( data ) {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let current = document.getElementById( 'algorithms_menu' ).value;
	numAlgorithms = extractShort( data );
	let str = '';
	for ( let i=0; i<numAlgorithms; ++i ) {
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x31, (i>>14)&3, (i>>7)&0x7f, i&0x7f, 0xF7 ];
		output.send( arr );
		let dd = log( "sent algorithm info request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );

		str += '<option value =' + i + '>' + (i+1) + '</option>';
	}
	let m = document.getElementById( 'algorithms_menu' );
	m.innerHTML = str;
	if ( current != "" ) {
		document.getElementById( 'algorithms_menu' ).value = current;
	}
}

var factories = [];

function processAlgorithmInfo( data ) {
	let index = extractShort( data.slice( 0, 3 ) );
	let guid = data.slice( 3, 7 );
	let numSpecs = data[7];
	let factory = [ guid, numSpecs ];
	let algSpecs = [];
	let c = 8;
	for ( let i=0; i<numSpecs; ++i ) {
		let spec = [ extractShort( data.slice( c, c+3 ) ), extractShort( data.slice( c+3, c+6 ) ), extractShort( data.slice( c+6, c+9 ) ), data[c+9] ];
		c += 10;
		algSpecs.push( spec );
	}
	factory.push( algSpecs );
	let names = [];
	for ( let j=0; j<1+numSpecs; ++j ) {
		let name = "";
		for ( let i = 0; i < 32; ++i ) {
			let n = data[c++];
			if ( n == 0 || n == 0xf7 ) {
				break;
			}
			name += String.fromCharCode( n );
		}
		names.push( name );
	}
	factory.push( names );
	let isPlugin = data[c++];
	let isLoaded = data[c++];
	let filename = "";
	for ( let i = 0; i < 256 && c < data.length; ++i ) {
		let n = data[c++];
		if ( n == 0 || n == 0xf7 ) {
			break;
		}
		filename += String.fromCharCode( n );
	}
	factory.push( [ isPlugin, isLoaded, filename ] );
	if ( index == 0 ) {
		factories = [];
	}
	factories.push( factory );
	let m = document.getElementById( 'algorithms_menu' );
	m.options[ index ].text = names[0];
	if ( filename.length > 0 ) {
		m.options[ index ].text += " - " + filename;
	}

	if ( index == numAlgorithms-1 ) {
		changeAlgorithm();

		let slot = document.getElementById( 'slot' ).value;
		let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x40, slot, 0xF7 ];
		output.send( arr );
		let dd = log( "sent algorithm request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	}
}

var slotCount = 0;
var routingInfo = [];
var guids = [];
var slotNames = [];

function processSlotCount( data ) {
	slotCount = data[0];
	routingInfo = [];
	guids = [];
	slotNames = [];

	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	for ( let i=0; i<slotCount; ++i ) {
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x40, i, 0xF7 ];
		output.send( arr );
		arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x61, i, 0xF7 ];
		output.send( arr );
		let dd = log( "sent routing request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	}
}

function processRoutingInfo( data ) {
	let slot = data[0];
	if ( slot >= slotCount ) {
		return;
	}
	let routing = [];
	let c = 1;
	for ( let i=0; i<6; ++i ) {
		let d = data[c+0] | ( data[c+1] << 7 ) | ( data[c+2] << 14 ) | ( data[c+3] << 21 ) | ( data[c+4] << 28 );
		c += 5;
		routing.push( d );
	}
	routingInfo[ slot ] = routing;
	
	if ( slot == ( slotCount - 1 ) ) {
		buildRoutingInfo();
	}
}

function processCPUUsage( data ) {
	let cpu1 = data[0];
	let cpu2 = data[1];
	// data[2] and onwards are the usages for each slot
	document.getElementById( "cpu_usage" ).innerHTML = "CPU: " + cpu1 + '% ' + cpu2 + '%';
}

function netInputMask( r ) {
    let inputMask = r[0];
	let mappingMask = r[5];
	let showSignals = document.getElementById( 'show_signals' ).checked;
	let showMappings = document.getElementById( 'show_mappings' ).checked;
	if ( showSignals && showMappings ) {
		return inputMask | mappingMask;
	} else if ( showSignals ) {
		return inputMask;
	} else if ( showMappings ) {
		return mappingMask;
	}
	return 0;
}

function hex2( d ) {
	let r = Number( d.toFixed(0) ).toString(16);
	if ( r.length == 1 ) {
		r = '0' + r;
	}
	return r;
}

function darken( c ) {
	let p = 0.9;
	let r = parseInt( c.substring(1,3), 16 ) * p;
	let g = parseInt( c.substring(3,5), 16 ) * p;
	let b = parseInt( c.substring(5,7), 16 ) * p;
	let h = '#';
	h += hex2( r );
	h += hex2( g );
	h += hex2( b );
	return h;
}

function buildRoutingInfo() {
	let colour1 = document.getElementById( 'routing_colour1' ).value;
	let colour2 = document.getElementById( 'routing_colour2' ).value;
    localStorage.setItem( dntRoutingColour1Key, colour1 );
    localStorage.setItem( dntRoutingColour2Key, colour2 );

	// follow signals from top to bottom
	let signals = [ [0, 1,1,1,1,1,1,1,1,1,1,1,1, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0] ];
	for ( let s=0; s<slotCount; ++s ) {
		let r = routingInfo[ s ];
		let inputMask = netInputMask( r );
		let outputMask = r[1];
		let replaceMask = r[2];
		let row = signals[ signals.length - 1 ];
		let newRow = [ 0 ];
		for ( let i=1; i<=28; ++i ) {
			let v = row[i];
			if ( outputMask & (1<<i) ) {
				if ( replaceMask & (1<<i) ) {
					v = v + 1;
					if ( v > 2 ) {
						v = 1;
					}
				} else if ( v == 0 ) {
					v = 1;
				}
			}
			newRow.push( v );
		}
		signals.push( newRow );
	}
	
	// strip signals that go nowhere
	let showSignals = document.getElementById( 'show_signals' ).checked;
	for ( let i=1; i<=28; ++i ) {
		if ( showSignals && ( i == 13 ) ) {
			i = 21;
		}
		let hasInput = false;
		for ( let s=slotCount; s>=0; s-- ) {
			if ( s < slotCount ) {
				let r = routingInfo[ s ];
				let inputMask = netInputMask( r );
				let replaceMask = r[2];
				if ( replaceMask & (1<<i) ) {
					hasInput = false;
				}
				if ( inputMask & (1<<i) ) {
					hasInput = true;
				}
			}
			if ( !hasInput ) {
				signals[ s ][ i ] = 0;
			}
		}
	}

	let str = "<table class='routing'>";
	let heading = "<tr class='routing'><th colspan=4 />";
	for ( let i=0; i<28; ++i ) {
		let ch = 1 + i;
		let cl = "routingI";
		if ( ch > 12 ) {
			ch -= 12;
			cl = "routingO";
			if ( ch > 8 ) {
				ch -= 8;
				cl = "routingA";
			}
		}
		heading += "<th class='" + cl + "'>" + ch + "</th>";
	}
	heading += "</tr>";
	let heading2 = "<tr class='routing'><th colspan=4 /><th colspan=12>Inputs</th><th colspan=8>Outputs</th><th colspan=8>Aux</th></tr>";
	str += heading2;
	str += heading;
	let colours = [ "#ffffff", colour1, colour2, "#fcfcfc", darken( colour1 ), darken( colour2 ) ];
	for ( let s=0; s<slotCount; ++s ) {
		let r = routingInfo[ s ];
		let inputMask = netInputMask( r );
		let outputMask = r[1];
		let replaceMask = r[2];
		let effectiveInput = inputMask | ( outputMask & ~replaceMask );
		let row = signals[ s ];
		str += "<tr class='routing'><td colspan=3 /><td />";
		for ( let i=1; i<=28; ++i ) {
			let ch = i;
			if ( ch > 12 ) {
				ch -= 12;
				if ( ch > 8 ) {
					ch -= 8;
				}
			}
			let sty = "background-color:" + colours[ row[i] + 3*(i&1) ];
			let cl = ( ch == 1 ) ? 'routingL' : 'routing';
			str += "<td class='" + cl + "' style='" + sty + "'>" + ( ( effectiveInput & (1<<i) ) ? "&darr;" : "&nbsp;" ) + "</td>";
		}
		str += "</tr>";
		str += "<tr class='routingSlot'>";
		str += s ? "<td class='routingSlotName'><button class='moveSlot' onclick='moveSlotUp(" + s + ")'>&uarr;</button></td>" : "<td />";
		str += (s<slotCount-1) ? "<td class='routingSlotName'><button class='moveSlot' onclick='moveSlotDown(" + s + ")'>&darr;</button></td>" : "<td />";
		str += "<td class='routingSlotName'><button onclick='editSlot(" + s + ")'>" + (s+1) + "</button></td>";
		str += "<td class='routingSlotName'>" + slotNames[s] + "</td>";
		let used = r[0] | r[5] | outputMask;
		for ( let i=1; i<=28; ++i ) {
			let ch = i;
			if ( ch > 12 ) {
				ch -= 12;
				if ( ch > 8 ) {
					ch -= 8;
				}
			}
			let sty = "background-color:" + ( ( used & (1<<i) ) ? "#d0d0d0" : ( row[i] ? colours[ row[i] + 3*(i&1) ] : "#f0f0f0" ) );
			let cl = ( ch == 1 ) ? 'routingL' : 'routing';
			str += "<td class='" + cl + "' style='" + sty + "'>" + ( ( used & (1<<i) ) ? ch : "&nbsp;" ) + "</td>";
		}
		str += "</tr>";
		row = signals[ s+1 ];
		str += "<tr class='routing'><td colspan=3 /><td />";
		for ( let i=1; i<=28; ++i ) {
			let ch = i;
			if ( ch > 12 ) {
				ch -= 12;
				if ( ch > 8 ) {
					ch -= 8;
				}
			}
			let sty = "background-color:" + colours[ row[i] + 3*(i&1) ];
			let cl = ( ch == 1 ) ? 'routingL' : 'routing';
			let replace = replaceMask & (1<<i);
			str += "<td class='" + cl + "' style='" + sty + "'>" + ( ( outputMask & (1<<i) ) ? ( replace ? "&#9523;" : "+" ) : "&nbsp;" ) + "</td>";
		}
		str += "</tr>";
	}
	str += heading;
	str += heading2;
	str += "</table>";
	document.getElementById( 'routingAnalysisContent' ).innerHTML = str;
}

function editSlot( s ) {
	document.getElementById( "slot" ).value = s;
	showSlotEditor();
}

function showMappings( n ) {
	let vis = document.getElementById( "show_mapping_"+n ).checked ? "table-cell" : "none";
	let elts = document.getElementsByClassName( 'map_'+n );
	for ( let e of elts ) {
    	e.style.display = vis;
	}
}

function toggleMappings( n ) {
	showMappings( n );
	if ( !mappingRefreshed ) {
		requestMapping() ;
	}
}

var mappingRefreshed = false;
var mappingTypes = [ "cv", "midi", "i2c" ];

function anyMappingVisible() {
	for ( let n of mappingTypes ) {
		if ( document.getElementById( "show_mapping_"+n ).checked ) {
			return true;
		}
	}
	return false;
}

function refreshMappingVisibility() {
	for ( let n of mappingTypes ) {
		showMappings( n );
	}
}

unitStrings = [];
function processUnitStrings( data ) {
	var num = data[0];
	var c = 1;
	unitStrings = [];
    for ( var j = 0; j < num; ++j ) {
		var name = "";
		for ( var i = 0; i < 100; ++i ) {
			var n = data[c++];
			if ( n == 0 ) {
				break;
			}
			name += String.fromCharCode( n );
		}
		unitStrings.push( name );
	}
}

function processEnumStrings( data ) {
	var p = extractShort( data.slice( 0, 3 ) );
	var num = data[3];
	var c = 4;
	var str = "";
	let toggle = ( num == 2 );
    for ( var j = 0; j < num; ++j ) {
		var name = "";
		for ( var i = 0; i < 100; ++i ) {
			var n = data[c++];
			if ( n == 0 ) {
				break;
			}
			name += String.fromCharCode( n );
		}
		str += "<option value=" + j + ">" + name + "</option>";
		if ( j == 0 && name != "Off" ) {
			toggle = false;
		}
		if ( j == 1 && name != "On" ) {
			toggle = false;
		}
	}
	if ( toggle ) {
		var e = document.getElementById( "p" + p + "_c" );
		var v = document.getElementById( "p" + p + "_s" ).value;
		e.checked = v != 0;
		e.style = 'display:inline;';
	}
	else {
		var e = document.getElementById( "p" + p + "_e" );
		e.innerHTML = str;
		e.value = document.getElementById( "p" + p + "_s" ).value;
		e.style = 'display:inline;';
	}
}

var mappingVersion = 4;

function processMapping( data ) {
	let p = extractShort( data.slice( 0, 3 ) );
	let c = 3;
	let version = data[c]; c++;
	if ( version < 1 || version > 4 ) {
		alert( "Unknown mapping data version" );
		return;
	}
	mappingVersion = version;
	{
		let source = 0;
		if ( version >= 4 ) {
			source = data[c]; c++;
		}
		let input = data[c]; c++;
		let flags = data[c]; c++;
		let volts = data[c]; c++;
		let delta = extractShort( data.slice( c, c+3 ) ); c += 3;

		document.getElementById( "p" + p + "_source" ).value = source;
		document.getElementById( "p" + p + "_cv_input" ).value = input;
		document.getElementById( "p" + p + "_cv_uni" ).checked = flags & 1;
		document.getElementById( "p" + p + "_cv_gate" ).checked = flags & 2;
		document.getElementById( "p" + p + "_cv_volts" ).value = volts;
		document.getElementById( "p" + p + "_cv_delta" ).value = delta;

		style_cv_input( p );
	}
	{
		let cc = data[c]; c++;
		let flags = data[c]; c++;
		let flags2 = 0;
		if ( version >= 2 ) {
			flags2 = data[c]; c++;
		}
		let min = extractShort( data.slice( c, c+3 ) ); c += 3;
		let max = extractShort( data.slice( c, c+3 ) ); c += 3;
		if ( flags & 4 ) {
			cc = 128;
		}
		let type = ( flags2 & 4 ) ? ( ( flags2 & 2 ) ? 2 : 1 ) : 0;
		document.getElementById( "p" + p + "_midi_ch" ).value = ( flags >> 3 ) & 0xf;
		document.getElementById( "p" + p + "_midi_type" ).value = type;
		document.getElementById( "p" + p + "_midi_cc" ).value = cc;
		document.getElementById( "p" + p + "_midi_en" ).checked = flags & 1;
		document.getElementById( "p" + p + "_midi_sym" ).checked = flags & 2;
		document.getElementById( "p" + p + "_midi_rel" ).checked = flags2 & 1;
		document.getElementById( "p" + p + "_midi_min" ).value = min;
		document.getElementById( "p" + p + "_midi_max" ).value = max;
	}
	{
		let cc = data[c]; c++;
		if ( version >= 3 ) {
			cc |= ( data[c] & 1 ) << 7; c++;
		}
		let flags = data[c]; c++;
		let min = extractShort( data.slice( c, c+3 ) ); c += 3;
		let max = extractShort( data.slice( c, c+3 ) ); c += 3;
		document.getElementById( "p" + p + "_i2c_cc" ).value = cc;
		document.getElementById( "p" + p + "_i2c_en" ).checked = flags & 1;
		document.getElementById( "p" + p + "_i2c_sym" ).checked = flags & 2;
		document.getElementById( "p" + p + "_i2c_min" ).value = min;
		document.getElementById( "p" + p + "_i2c_max" ).value = max;
	}
	mappingRefreshed = true;
}

nextParameterToGet = 0;
numParametersToGet = 0;
function getNextParameter() {
	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x43, slot, (nextParameterToGet>>14)&3, (nextParameterToGet>>7)&0x7f, nextParameterToGet&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent parameter info request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	nextParameterToGet += 1;
	if ( nextParameterToGet >= numParametersToGet ) {
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x44, slot, 0xF7 ];
		output.send( arr );
		let dd = log( "sent parameter values request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
		return;
	}
	setTimeout( getNextParameter, 20 );
}

numParameters = 0;
function processNumParameters( data ) {
	let num = extractShort( data.slice( 0, 3 ) );
	if ( num >= 256 ) {
		alert( "Invalid num parameters in processNumParameters()" );
		return;
	}
	numParameters = num;
	let str = "<table>";
	str += parameterTableHeader();
	str += "<tbody>";

	for ( let i=0; i<num; ++i ) {
		str += "<tr id=row" + i + " class=" + ((i&1)?"a":"b") + ">";
		str += tableRowForParameter( i );
		str += "</tr>";
	}

	str += "</tbody></table>";
	document.getElementById( "parameters" ).innerHTML = str;
	nextParameterToGet = 0;
	numParametersToGet = num;
	setTimeout( getNextParameter, 20 );

	refreshMappingVisibility();
	mappingRefreshed = false;
	if ( anyMappingVisible() ) {
		requestMapping();
	}
}

function parameterTableHeader() {
	let str = "";
	str += "<thead>";
	str += "<tr><th colspan=8>Preset</th><th colspan=6 class='map_cv'>CV Mapping</th><th colspan=8 class='map_midi'>MIDI Mapping</th><th colspan=5 class='map_i2c'>I2C Mapping</th></tr>";
	str += "<tr><th></th><th>Name</th><th>Min</th><th>Max</th><th>Default</th><th>Unit</th><th>Value</th><th>Control</th>";
	str += "<th class='map_cv'>Source</th><th class='map_cv'>Bus</th><th class='map_cv'>Unipolar</th><th class='map_cv'>Gate</th><th class='map_cv'>Volts</th><th class='map_cv'>Delta</th>";
	str += "<th class='map_midi'>Channel</th><th class='map_midi'>Type</th><th class='map_midi'>CC</th><th class='map_midi'>Enabled</th><th class='map_midi'>Relative</th><th class='map_midi'>Symmetric</th><th class='map_midi'>Min</th><th class='map_midi'>Max</th>";
	str += "<th class='map_i2c'>ID</th><th class='map_i2c'>Enabled</th><th class='map_i2c'>Symmetric</th><th class='map_i2c'>Min</th><th class='map_i2c'>Max</th>";
	str += "</tr>";
	str += "</thead>";
	return str;
}

function tableRowForParameter( i ) {
	str = "";
		str += "<td>" + (i+1) + "</td>";
		str += "<td id=p" + i + "_name><h1>" + "</h1></td>";
		str += "<td id=p" + i + "_min>" + "</td>";
		str += "<td id=p" + i + "_max>" + "</td>";
		var focus = " onfocus='param_focus(" + i + ")' ";
		str += "<td><button id=p" + i + "_def class='param_def' onclick='param_def(" + i + ")'" + focus + "></button>";
		str += "<div id=p" + i + "_scl class='hidden'>1</div></td>";
		str += "<td id=p" + i + "_unit>" + "</td>";
		str += "<td><input id=p" + i + "_v type='number' class='param_v' size=6 onchange='param_text(" + i + ")'" + focus + ">" + "</td>";
		str += "<td>";
		str += "<input id=p" + i + "_s type='range' min='-32768' max='32767' class='param_s' onInput='param_slider(" + i + ")' ondblclick='param_def(" + i + ")'" + focus + ">";
		str += "<select id=p" + i + "_e class='param_e' onchange='param_enum(" + i + ")' style='display:none;'" + focus + "></select>";
		str += "<input id=p" + i + "_c type='checkbox' class='param_c' onchange='param_check(" + i + ")' style='display:none;'" + focus + ">";
		str += "<div class='pv_string' id=p" + i + "_pv></div>";
		str += "<input id=p" + i + "_n type='text' class='param_n' onchange='param_string(" + i + ")' style='display:none;'" + focus + ">";
		str += "</td>";

		{
			str += "<td class='map_cv'><select id=p" + i + "_source onchange='mapping_cv_source(" + i + ")'><option value=0>Own inputs</option><option value=1>Module inputs</option>";
			for ( let j=1; j<=32; ++j ) {
				str += "<option value=" + (1+j) + ">" + j + "</option>";
			}
			str += "</select></td>";
			str += "<td class='map_cv'><select id=p" + i + "_cv_input onchange='mapping_cv_input(" + i + ")'><option value=0>None</option>";
			for ( let j=1; j<=12; ++j ) {
				str += "<option value=" + j + ">Input " + j + "</option>";
			}
			for ( let j=1; j<=8; ++j ) {
				str += "<option value=" + (12+j) + ">Output " + j + "</option>";
			}
			for ( let j=1; j<=8; ++j ) {
				str += "<option value=" + (20+j) + ">Aux " + j + "</option>";
			}
			str += "</select></td>";
			str += "<td class='map_cv'><input id=p" + i + "_cv_uni type='checkbox' class='param_c' onchange='mapping_cv_uni(" + i + ")'></td>";
			str += "<td class='map_cv'><input id=p" + i + "_cv_gate type='checkbox' class='param_c' onchange='mapping_cv_gate(" + i + ")'></td>";
			str += "<td class='map_cv'><input id=p" + i + "_cv_volts type='number' class='param_v' size=3 step='1' min='1' max='12' onchange='mapping_cv_volts(" + i + ")'></td>";
			str += "<td class='map_cv'><input id=p" + i + "_cv_delta type='number' class='param_v' size=7 step='1' min='-32768' max='32767' onchange='mapping_cv_delta(" + i + ")'></td>";
		}

			str += "<td class='map_midi'><select id=p" + i + "_midi_ch class='param_v' onchange='mapping_midi_ch(" + i + ")'>";
			for ( let j=0; j<16; ++j ) {
				str += "<option value=" + j + ">" + (j+1) + "</option>";
			}
			str += "</select></td>";
			str += "<td class='map_midi'><select id=p" + i + "_midi_type class='param_v' onchange='mapping_midi_type(" + i + ")'>";
			str += "<option value=0>CC</option><option value=1>Note - momentary</option><option value=2>Note - toggle</option>";
			str += "</select></td>";
			str += "<td class='map_midi'><select id=p" + i + "_midi_cc class='param_v' onchange='mapping_midi_cc(" + i + ")'>";
			for ( let j=0; j<128; ++j ) {
				str += "<option value=" + j + ">" + j + "</option>";
			}
			str += "<option value=128>Aftertouch</option></select></td>";
			str += "<td class='map_midi'><input id=p" + i + "_midi_en type='checkbox' class='param_c' onchange='mapping_midi_en(" + i + ")'></td>";
			str += "<td class='map_midi'><input id=p" + i + "_midi_rel type='checkbox' class='param_c' onchange='mapping_midi_rel(" + i + ")'></td>";
			str += "<td class='map_midi'><input id=p" + i + "_midi_sym type='checkbox' class='param_c' onchange='mapping_midi_sym(" + i + ")'></td>";
			str += "<td class='map_midi'><input id=p" + i + "_midi_min type='number' class='param_v' size=6 min='-32768' max='32767' onchange='mapping_midi_min(" + i + ")'></td>";
			str += "<td class='map_midi'><input id=p" + i + "_midi_max type='number' class='param_v' size=6 min='-32768' max='32767' onchange='mapping_midi_max(" + i + ")'></td>";

			str += "<td class='map_i2c'><input id=p" + i + "_i2c_cc type='number' class='param_v' size=3 min='0' max='255' onchange='mapping_i2c_cc(" + i + ")'></td>";
			str += "<td class='map_i2c'><input id=p" + i + "_i2c_en type='checkbox' class='param_c' onchange='mapping_i2c_en(" + i + ")'></td>";
			str += "<td class='map_i2c'><input id=p" + i + "_i2c_sym type='checkbox' class='param_c' onchange='mapping_i2c_sym(" + i + ")'></td>";
			str += "<td class='map_i2c'><input id=p" + i + "_i2c_min type='number' class='param_v' size=6 min='-32768' max='32767' onchange='mapping_i2c_min(" + i + ")'></td>";
			str += "<td class='map_i2c'><input id=p" + i + "_i2c_max type='number' class='param_v' size=6 min='-32768' max='32767' onchange='mapping_i2c_max(" + i + ")'></td>";

	return str;
}

function initView() {
  document.getElementById( "slot_algorithm_name" ).innerHTML = '<i>Add an algorithm...</i>';
  document.getElementById( "parameters" ).innerHTML = '';
}

nextMappingToGet = 0;
numMappingsToGet = 0;
function getNextMapping() {
	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x4B, slot, (nextMappingToGet>>14)&3, (nextMappingToGet>>7)&0x7f, nextMappingToGet&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent mapping request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	nextMappingToGet += 1;
	if ( nextMappingToGet >= numMappingsToGet ) {
		return;
	}
	setTimeout( getNextMapping, 20 );
}

function requestMapping() {
	nextMappingToGet = 0;
	numMappingsToGet = numParameters;
	setTimeout( getNextMapping, 20 );
}

function extractShort( data ) {
	var v = ( data[0] << 14 ) | ( data[1] << 7 ) | ( data[2] );
	v = ( v << 16 ) >> 16;
	return v;
}

function processParameterInfo( data ) {
	var p = extractShort( data.slice( 0, 3 ) );
	var min = extractShort( data.slice( 3, 6 ) );
	var max = extractShort( data.slice( 6, 9 ) );
	var def = extractShort( data.slice( 9, 12 ) );
	var unit = data[12];
	var name = "";
	let i;
	for ( i = 0; i < 24; ++i ) {
		var n = data[13+i];
		if ( n == 0 ) {
			++i;
			break;
		}
		name += String.fromCharCode( n );
	}
	let scaling = 1;
	if ( 13+i < data.length )
		scaling = 10 ** data[13+i];
	if ( name.length == 0 ) {
		document.getElementById( "row" + p ).style='display:none;';
	}
	document.getElementById( "p" + p + "_min" ).innerHTML = Number(min) / scaling;
	document.getElementById( "p" + p + "_max" ).innerHTML = Number(max) / scaling;
	document.getElementById( "p" + p + "_def" ).innerHTML = Number(def) / scaling;
	document.getElementById( "p" + p + "_scl" ).innerHTML = scaling;
	var unitStr = "";
	if ( unit < 1 && min == 0 && max == 1 ) {
		var e = document.getElementById( "p" + p + "_c" );
		var v = document.getElementById( "p" + p + "_s" ).value;
		e.checked = v != 0;
		e.style = 'display:inline;';
	} else if ( unit == 1 ) {
		let slot = document.getElementById( 'slot' ).value;
		let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x49, slot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 0xF7 ];
		output.send( arr );
		let dd = log( "sent enum string request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	} else if ( unit == 13 || unit == 14 || unit == 17 ) {
		unitStr = "<br>";
		setTimeout( requestParameterValueString, 1000, p );
		if ( unit == 17 ) {
			document.getElementById( "p" + p + "_pv" ).style = 'display:none;';
			document.getElementById( "p" + p + "_n" ).style = 'display:inline;';
		}
	} else if ( unit > 0 && (unit-1) < unitStrings.length ) {
		unitStr = unitStrings[ unit-1 ];
	}
	document.getElementById( "p" + p + "_unit" ).innerHTML = unitStr;
	document.getElementById( "p" + p + "_name" ).innerHTML = name;
	var s = document.getElementById( "p" + p + "_s" );
	s.min = min;
	s.max = max;
}

function processAllParameterValues( data ) {
	var p;
	var num = data.length / 3;
	var c = 0;
	for ( p=0; p<num; ++p ) {
		var v = extractShort( data.slice( c, c+3 ) );
		c += 3;
		if ( document.getElementById( "p" + p + "_v" ) == null ) {
			continue;
		}
		let scl = document.getElementById( "p" + p + "_scl" ).innerHTML;
		document.getElementById( "p" + p + "_v" ).value = v / scl;
	    document.getElementById( "p" + p + "_s" ).value = v;
	    document.getElementById( "p" + p + "_e" ).value = v;
	    document.getElementById( "p" + p + "_c" ).checked = v;
	}
}

function processParameterValue( data ) {
	let p = extractShort( data.slice( 0, 3 ) );
	let v = extractShort( data.slice( 3, 6 ) );
	let scl = document.getElementById( "p" + p + "_scl" ).innerHTML;
    document.getElementById( "p" + p + "_v" ).value = v / scl;
    document.getElementById( "p" + p + "_s" ).value = v;
    document.getElementById( "p" + p + "_e" ).value = v;
    document.getElementById( "p" + p + "_c" ).checked = v;
}

function processParameterValueString( data ) {
	let p = extractShort( data.slice( 0, 3 ) );
	let name = "";
	for ( let i = 0; i < 32; ++i ) {
		let n = data[3+i];
		if ( n == 0 ) {
			break;
		}
		name += String.fromCharCode( n );
	}
    document.getElementById( "p" + p + "_pv" ).innerHTML = name;
    document.getElementById( "p" + p + "_n" ).value = name;
}

function processParameterPages( data ) {
	let str = "<table>";
	str += parameterTableHeader();
	str += "<tbody>";

	let clas = 0;
	let c = 0;
	let num = 0;
	let numPages = data[c++];
	for ( let p=0; p<numPages; ++p ) {
		let name = "";
		for ( let i = 0; i < 32; ++i ) {
			let n = data[c++];
			if ( n == 0 ) {
				break;
			}
			name += String.fromCharCode( n );
		}
		str += "<tr><th colspan=2>" + name + "</th></tr>";
		let nump = data[c++];
		for ( let i=0; i<nump; ++i ) {
			let pp = ( data[c] << 7 ) | data[c+1];
			c += 2;
			str += "<tr id=row" + pp + " class=" + ((clas&1)?"a":"b") + ">";
			str += tableRowForParameter( pp );
			str += "</tr>";
			clas++;
			num = Math.max( num, pp+1 );
		}
	}

	str += "</tbody></table>";

	document.getElementById( "parameters" ).innerHTML = str;
	numParameters = num;
	nextParameterToGet = 0;
	numParametersToGet = num;
	setTimeout( getNextParameter, 20 );

	refreshMappingVisibility();
	mappingRefreshed = false;
	if ( anyMappingVisible() ) {
		requestMapping();
	}
}

function requestParameterValue( p ) {
	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x45, slot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent parameter value request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function requestParameterValueString( p ) {
	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x50, slot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent parameter value string request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function send_preset_name() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x47 ];
	let name = document.getElementById( "preset_name" ).value;
	for ( let i = 0; i < name.length; ++i ) {
		arr.push( name.charCodeAt( i ) );
	}
	arr.push( 0x00 );
	arr.push( 0xF7 );
	output.send( arr );
	let dd = log( "sent preset name update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function send_slot_name() {
	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x51, slot ];
	let name = document.getElementById( "slot_name" ).value;
	for ( let i = 0; i < name.length; ++i ) {
		arr.push( name.charCodeAt( i ) );
	}
	arr.push( 0x00 );
	arr.push( 0xF7 );
	output.send( arr );
	let dd = log( "sent slot name update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function sendSetValue( p, v ) {
	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x46, slot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, (v>>14)&3, (v>>7)&0x7f, v&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent parameter update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	setTimeout( requestParameterValue, 5, p );
	let unitStr = document.getElementById( "p" + p + "_unit" ).innerHTML;
	if ( unitStr == "<br>" ) {
		setTimeout( requestParameterValueString, 10, p );
	}
}

function param_def( p ) {
	let v = document.getElementById( "p" + p + "_def" ).innerHTML;
	v *= document.getElementById( "p" + p + "_scl" ).innerHTML;
	sendSetValue( p, v );
}

function param_slider( p ) {
	var v = document.getElementById( "p" + p + "_s" ).value;
	sendSetValue( p, v );
}

function param_enum( p ) {
	var v = document.getElementById( "p" + p + "_e" ).value;
	sendSetValue( p, v );
}

function param_check( p ) {
	var v = document.getElementById( "p" + p + "_c" ).checked;
	sendSetValue( p, v );
}

function param_text( p ) {
	let v = document.getElementById( "p" + p + "_v" ).value;
	v *= document.getElementById( "p" + p + "_scl" ).innerHTML;
	sendSetValue( p, v );
}

function param_string( p ) {
	let v = document.getElementById( "p" + p + "_n" ).value;
	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x53, slot, (p>>14)&3, (p>>7)&0x7f, p&0x7f ];
	for ( let i = 0; i < v.length; ++i ) {
		arr.push( v.charCodeAt( i ) );
	}
	arr.push( 0x00 );
	arr.push( 0xF7 );
	output.send( arr );
	let dd = log( "sent parameter update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	setTimeout( requestParameterValueString, 10, p );
}

function param_focus( p ) {
	if ( document.getElementById( 'auto_focus' ).checked ) {
		let slot = document.getElementById( 'slot' ).value;
		let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x4A, slot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, 0xF7 ];
		output.send( arr );
		let dd = log( "sent focus update to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	}
}

function mapping_send( p ) {
	let source = document.getElementById( "p" + p + "_source" ).value;
	let input = document.getElementById( "p" + p + "_cv_input" ).value;
	let cv_uni = document.getElementById( "p" + p + "_cv_uni" ).checked;
	let cv_gate = document.getElementById( "p" + p + "_cv_gate" ).checked;
	let flags = cv_uni | ( cv_gate << 1 );
	let volts = document.getElementById( "p" + p + "_cv_volts" ).value;
	let delta = document.getElementById( "p" + p + "_cv_delta" ).value;

	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x4D, slot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, mappingVersion ];
	if ( mappingVersion >= 4 ) {
		arr.push( source );
	}
	arr.push( input, flags, volts, (delta>>14)&3, (delta>>7)&0x7f, delta&0x7f, 0xF7 );
	output.send( arr );
	let dd = log( "sent CV mapping update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function style_cv_input( p ) {
	let e = document.getElementById( "p" + p + "_cv_input" );
	let v = e.value;
	e.style.background = v > 0 ? "chartreuse" : "";
}

function mapping_cv_source( p ) {
	mapping_send( p );
}
function mapping_cv_input( p ) {
	style_cv_input( p );
	mapping_send( p );
}
function mapping_cv_uni( p ) {
	mapping_send( p );
}
function mapping_cv_gate( p ) {
	mapping_send( p );
}
function mapping_cv_scale( p ) {
	mapping_send( p );
}
function mapping_cv_volts( p ) {
	mapping_send( p );
}
function mapping_cv_delta( p ) {
	mapping_send( p );
}

function mapping_midi( p ) {
	let ch = document.getElementById( "p" + p + "_midi_ch" ).value;
	let type = document.getElementById( "p" + p + "_midi_type" ).value;
	let cc = document.getElementById( "p" + p + "_midi_cc" ).value;
	let en = document.getElementById( "p" + p + "_midi_en" ).checked;
	let sym = document.getElementById( "p" + p + "_midi_sym" ).checked;
	let rel = document.getElementById( "p" + p + "_midi_rel" ).checked;
	let flags = en | ( sym << 1 ) | ( ( ch & 0xf ) << 3 );
	let toggle = ( type == 2 );
	let mtype = ( type != 0 );
	let flags2 = rel | ( toggle << 1 ) | ( mtype << 2 );
	let min = document.getElementById( "p" + p + "_midi_min" ).value;
	let max = document.getElementById( "p" + p + "_midi_max" ).value;

	if ( cc == 128 ) {
		cc = 0;
		flags |= (1<<2);
	}

	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x4E, slot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, mappingVersion, cc, flags ];
	if ( mappingVersion >= 2 ) {
		arr.push( flags2 );
	}
	arr.push( (min>>14)&3, (min>>7)&0x7f, min&0x7f, (max>>14)&3, (max>>7)&0x7f, max&0x7f, 0xF7 );
	output.send( arr );
	let dd = log( "sent midi mapping update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function mapping_midi_ch( p ) {
	mapping_midi( p );
}
function mapping_midi_type( p ) {
	mapping_midi( p );
}
function mapping_midi_cc( p ) {
	mapping_midi( p );
}
function mapping_midi_en( p ) {
	mapping_midi( p );
}
function mapping_midi_sym( p ) {
	mapping_midi( p );
}
function mapping_midi_rel( p ) {
	mapping_midi( p );
}
function mapping_midi_min( p ) {
	mapping_midi( p );
}
function mapping_midi_max( p ) {
	mapping_midi( p );
}

function mapping_i2c( p ) {
	let cc = document.getElementById( "p" + p + "_i2c_cc" ).value;
	let en = document.getElementById( "p" + p + "_i2c_en" ).checked;
	let sym = document.getElementById( "p" + p + "_i2c_sym" ).checked;
	let flags = en | ( sym << 1 );
	let min = document.getElementById( "p" + p + "_i2c_min" ).value;
	let max = document.getElementById( "p" + p + "_i2c_max" ).value;

	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x4F, slot, (p>>14)&3, (p>>7)&0x7f, p&0x7f, mappingVersion, cc&0x7f ];
	if ( mappingVersion >= 3 ) {
		arr.push( (cc>>7)&0x7f );
	}
	arr.push( flags, (min>>14)&3, (min>>7)&0x7f, min&0x7f, (max>>14)&3, (max>>7)&0x7f, max&0x7f, 0xF7 );
	output.send( arr );
	let dd = log( "sent midi mapping update to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function mapping_i2c_cc( p ) {
	mapping_i2c( p );
}
function mapping_i2c_en( p ) {
	mapping_i2c( p );
}
function mapping_i2c_sym( p ) {
	mapping_i2c( p );
}
function mapping_i2c_min( p ) {
	mapping_i2c( p );
}
function mapping_i2c_max( p ) {
	mapping_i2c( p );
}
</script>

<script>
var midi, data;
const dntMIDIInKey = "dntMIDIInKey";
const dntMIDIOutKey = "dntMIDIOutKey";
const dexSysExKey = "dexSysExKey";
const defaultDntPortName = "disting NT";
const dntPagesKey = "dntUsePages";

var dexInPortName = defaultDntPortName;
var dexOutPortName = defaultDntPortName;
var sysExId ;

if(!localStorage.getItem(dntMIDIInKey)) {  // No input stored
    localStorage.setItem(dntMIDIInKey, defaultDntPortName);
}
else {
    dexInPortName = localStorage.getItem(dntMIDIInKey);
}

if(!localStorage.getItem(dntMIDIOutKey)) {  // No output stored
    localStorage.setItem(dntMIDIOutKey, defaultDntPortName);
}
else {
    dexOutPortName = localStorage.getItem(dntMIDIOutKey);
}

if(!localStorage.getItem(dexSysExKey)) {  // No system exclusive ID stored
    localStorage.setItem(dexSysExKey, 0);
}
sysExId = localStorage.getItem(dexSysExKey);

var sendRTC = true;
var usePages = false;

if(!localStorage.getItem(dntPagesKey)) {  // No system exclusive ID stored
    localStorage.setItem(dntPagesKey, false);
}
usePages = localStorage.getItem(dntPagesKey);
document.getElementById( 'show_pages' ).value = usePages;

function changePages() {
	usePages = document.getElementById( 'show_pages' ).value;
    localStorage.setItem(dntPagesKey, usePages);
	refresh();
}

if ( navigator.requestMIDIAccess ) {
    navigator.requestMIDIAccess ( {
        sysex: true
    } ).then(onMIDISuccess, onMIDIFailure);
} else {
    status("No MIDI support in your browser.");
}
function onMIDISuccess(midiAccess) {
    midi = midiAccess;
    let str = "";
    let dex = -1;
    let inputs = midi.inputs.values();

    for ( var input = inputs.next(); input && !input.done; input = inputs.next() ) {
	    str += "<option value='" + input.value.id + "'>" + input.value.name + "</option>";
	    if ( input.value.name == dexInPortName ) {
		    dex = input.value.id;
	    }
    }
    document.getElementById( "midiinput" ).innerHTML = str
    if ( dex != -1 ) {
	    document.getElementById( "midiinput" ).value = dex;
    }

    str = "";
    dex = -1;
    let outputs = midi.outputs.values();

    for ( var output = outputs.next(); output && !output.done; output = outputs.next() ) {
	    str += "<option value='" + output.value.id + "'>" + output.value.name + "</option>";
	    if ( output.value.name == dexOutPortName ) {
		    dex = output.value.id;
	    }
    }
    document.getElementById( "midioutput" ).innerHTML = str
    if ( dex != -1 ) {
	    document.getElementById( "midioutput" ).value = dex;
    }

	document.getElementById("sysExId").selectedIndex = sysExId;
	changeInput();

	log( "midi access granted" );
    status("OK");
    initView();
	updateCPUVisibility();

    // Set the slot number from the query string
    let { slot } = getQueryParams();
    if (slot){
      document.getElementById('slot').value = Number(slot) - 1;
    }

    request();
}
function onMIDIFailure(e) {
	log( "midi access failure" );
    status("No access to MIDI devices or your browser doesn't support WebMIDI API.");
}
function changeInput() {
    var inputs = midi.inputs.values();
    for ( var input = inputs.next(); input && !input.done; input = inputs.next() ) {
    	input.value.onmidimessage = "";
    }
	var input = midi.inputs.get( document.getElementById( "midiinput" ).value );
	input.onmidimessage = onMIDIMessage;

	// Save the current port setting
	let inputSelector = document.getElementById("midiinput");
let selectedPortName = inputSelector.options[inputSelector.selectedIndex].text;
    localStorage.setItem(dntMIDIInKey, selectedPortName);
}

function changeOutput() {
let outputSelector = document.getElementById("midioutput");
let selectedPortName = outputSelector.options[outputSelector.selectedIndex].text;
    localStorage.setItem(dntMIDIOutKey, selectedPortName);
    sendRTC = true;
}

function changeSysExId() {
	sysExId = document.getElementById( "sysExId" ).value;
   localStorage.setItem(dexSysExKey, sysExId);
   sendRTC = true;
}

function changeAlgorithm() {
	let index = document.getElementById( 'algorithms_menu' ).value;
	let factory = factories[ index ];
	let numSpecs = factory[ 1 ];
	for ( let i=0; i<3; ++i ) {
		if ( numSpecs > i ) {
			document.getElementById( 'spec' + (i+1) + 'label' ).innerHTML = factory[3][1+i] + ":";
			let t = document.getElementById( 'spec' + (i+1) );
			t.min = factory[2][i][0];
			t.max = factory[2][i][1];
			t.value = factory[2][i][2];
			t.style = 'display:inline;';
		} else {
			document.getElementById( 'spec' + (i+1) + 'label' ).innerHTML = "";
			document.getElementById( 'spec' + (i+1) ).style='display:none;';
		}
	}
	let unloadedPlugin = factory[4][0] && !factory[4][1];
	document.getElementById( 'loadPluginButton' ).disabled = !unloadedPlugin;
}

function addAlgorithm() {
	let index = document.getElementById( 'algorithms_menu' ).value;
	let factory = factories[ index ];
	let guid = factory[ 0 ];
	let numSpecs = factory[ 1 ];
	let specs = [ 0, 0, 0 ];
	for ( let i=0; i<3; ++i ) {
		if ( numSpecs > i ) {
			specs[i] = document.getElementById( 'spec' + (i+1) ).value;
		}
	}
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x32, guid[0], guid[1], guid[2], guid[3], (specs[0]>>14)&3, (specs[0]>>7)&0x7f, specs[0]&0x7f, (specs[1]>>14)&3, (specs[1]>>7)&0x7f, specs[1]&0x7f, (specs[2]>>14)&3, (specs[2]>>7)&0x7f, specs[2]&0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent add algorithm request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	changeSlot();
}

function loadPlugin() {
	let index = document.getElementById( 'algorithms_menu' ).value;
	let factory = factories[ index ];
	let guid = factory[ 0 ];
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x38, guid[0], guid[1], guid[2], guid[3], 0xF7 ];
	output.send( arr );
	let dd = log( "sent load plug-in request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	changeSlot();
}

function removeAlgorithm() {
	let slot = document.getElementById( 'slot' ).value;
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x33, slot, 0xF7 ];
	output.send( arr );
	let dd = log( "sent remove algorithm request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	changeSlot();
}

function loadPreset() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let append = 0;
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x34, append ];
	let name = "/presets/Aleatoric Piano.json";
	for ( let i = 0; i < name.length; ++i ) {
		arr.push( name.charCodeAt( i ) );
	}
	arr.push( 0x00 );
	arr.push( 0xF7 );
	output.send( arr );
	let dd = log( "sent load preset request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function newPreset() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x35, 0xF7 ];
	output.send( arr );
	let dd = log( "sent new preset request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function savePreset( option ) {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x36, option, 0xF7 ];
	output.send( arr );
	let dd = log( "sent save preset request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function moveSlotUp( s ) {
	moveSlot( s, s-1 );
}
function moveSlotDown( s ) {
	moveSlot( s, s+1 );
}
function moveSlot( s, ns ) {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x37, s & 0x7f, ns & 0x7f, 0xF7 ];
	output.send( arr );
	let dd = log( "sent move algorithm request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
	setTimeout( requestRouting, 50 );
}

function changeSlot() {
    initView();
	request();
}

function onMIDIMessage(message) {
    data = message.data;
    let header = [ 240, 0, 33, 39, 0x6D, sysExId ];
    for ( var i=0; i<6; ++i ) {
    	if ( header[i] != data[i] ) {
    		return;
    	}
    }
	let slot = document.getElementById( 'slot' ).value;
	let rxSlot = data[7];
	let dd = log( "received sysex (" + data.length + " bytes)" );
	dumpSysex( data, "rxSysex", dd+"\n" );
	if ( data[6] == 0x30 ) {
		processNumAlgorithms( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x31 ) {
		processAlgorithmInfo( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x40 ) {
		if ( routingAnalysisMode || ( rxSlot == slot ) ) {
			processAlgorithm( rxSlot, data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x41 ) {
    	processPresetName( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x42 ) {
		if ( rxSlot == slot ) {
			processNumParameters( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x43 ) {
		if ( rxSlot == slot ) {
			processParameterInfo( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x44 ) {
		if ( rxSlot == slot ) {
			processAllParameterValues( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x45 ) {
		if ( rxSlot == slot ) {
			processParameterValue( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x48 ) {
		processUnitStrings( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x49 ) {
		if ( rxSlot == slot ) {
			processEnumStrings( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x4B ) {
		if ( rxSlot == slot ) {
			processMapping( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x50 ) {
		if ( rxSlot == slot ) {
			processParameterValueString( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x52 ) {
		if ( rxSlot == slot ) {
			processParameterPages( data.slice( 8, -1 ) );
		}
	} else if ( data[6] == 0x60 ) {
		processSlotCount( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x61 ) {
		processRoutingInfo( data.slice( 7, -1 ) );
	} else if ( data[6] == 0x62 ) {
		processCPUUsage( data.slice( 7, -1 ) );
	}
}

function wake() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x07, 0xF7 ];
	output.send( arr );
	let dd = log( "sent wake request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function refresh() {
	if ( routingAnalysisMode ) {
		requestRouting();
	} else {
		request();
	}
}
function request() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let slot = document.getElementById( 'slot' ).value;

	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x52, 0xF7 ];
	output.send( arr );
	var dd = log( "sent algorithm names request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x41, 0xF7 ];
	output.send( arr );
	var dd = log( "sent preset name request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x48, 0xF7 ];
	output.send( arr );
	var dd = log( "sent unit strings request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	if ( usePages == 'true' ) {
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x52, slot, 0xF7 ];
		output.send( arr );
		let dd = log( "sent parameter pages request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	}
	else {
		let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x42, slot, 0xF7 ];
		output.send( arr );
		let dd = log( "sent num parameters request to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	}

	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x30, 0xF7 ];
	output.send( arr );
	var dd = log( "sent num algorithms request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );

	mappingRefreshed = false;
	if ( sendRTC ) {
		sendRTC = false;
		let d = Math.floor( Date.now() / 1000 );
		let n = new Date( Date.now() );
		d -= n.getTimezoneOffset() * 60;
		var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x04,
			(d>>28)&0xf, (d>>21)&0x7f, (d>>14)&0x7f, (d>>7)&0x7f, (d>>0)&0x7f,
			0xF7 ];
		output.send( arr );
		var dd = log( "sent RTC update to disting NT" );
		dumpSysex( arr, "txSysex", dd+"\n" );
	}
}
function requestRouting() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	var arr = [ 0xF0, 0x00, 0x21, 0x27, 0x6D, sysExId, 0x60, 0xF7 ];
	output.send( arr );
	var dd = log( "sent slot count request to disting NT" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}
function sendMsg() {
	var str = makeMsgSysEx();
	var arr = new Uint8Array( str.length );
	for ( var i=0; i<str.length; ++i ) {
		arr[i] = str.charCodeAt( i );
	}
	var output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	output.send( arr );
	var dd = log( "sent sysex (" + str.length + " bytes)" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}

function getQueryParams() {
  const queryString = window.location.search; // Get the part after the "?"
  const urlParams = new URLSearchParams(queryString);
  const params = {};

  // Iterate through all the query parameters
  for (const [key, value] of urlParams.entries()) {
    params[key] = value;
  }

  return params;
}
</script>

</body>
